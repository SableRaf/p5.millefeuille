!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).p5Millefeuille={})}(this,function(e){"use strict";const t={NORMAL:"NORMAL",MULTIPLY:"MULTIPLY",SCREEN:"SCREEN",ADD:"ADD",SUBTRACT:"SUBTRACT"};function n(e,n){const a=n;switch(e){case t.NORMAL:return a.BLEND;case t.MULTIPLY:return a.MULTIPLY;case t.SCREEN:return a.LIGHTEST;case t.ADD:return a.ADD;case t.SUBTRACT:return a.SUBTRACT;default:return console.warn(`Unknown blend mode: ${e}, falling back to NORMAL`),a.BLEND}}const a={visible:!0,opacity:1,blendMode:t.NORMAL,width:null,height:null,density:null,depth:!1,antialias:!1};class r{constructor(e,t,n="",r={}){this.p=e,this.id=t,this.name=n||`Layer ${t}`;const i={...a,...r};if(this.visible=i.visible,this.opacity=this._clampOpacity(i.opacity),this.blendMode=i.blendMode,this.zIndex=void 0!==i.zIndex?i.zIndex:t,this.width=i.width||this.p.width,this.height=i.height||this.p.height,this.density=i.density||this.p.pixelDensity(),this.depth=i.depth,this.antialias=i.antialias,this.mask=null,this.framebuffer=this._createFramebuffer(),!this.framebuffer)throw new Error(`Failed to create framebuffer for layer ${this.name}`)}_createFramebuffer(){try{const e={width:this.width,height:this.height,density:this.density};return void 0!==this.depth&&(e.depth=this.depth),void 0!==this.antialias&&(e.antialias=this.antialias),this.p.createFramebuffer(e)}catch(e){return console.error(`Error creating framebuffer for layer ${this.name}:`,e),null}}_clampOpacity(e){return Math.max(0,Math.min(1,e))}setVisible(e){this.visible=!!e}setOpacity(e){this.opacity=this._clampOpacity(e)}setBlendMode(e){Object.values(t).includes(e)?this.blendMode=e:(console.warn(`Invalid blend mode: ${e}, using NORMAL`),this.blendMode=t.NORMAL)}setZIndex(e){this.zIndex=e}setMask(e){e?this.mask=e:console.warn("Invalid mask source provided")}clearMask(){this.mask=null}resize(e,t){this.width=e,this.height=t,this.framebuffer&&this.framebuffer.remove(),this.framebuffer=this._createFramebuffer()}begin(){this.framebuffer?this.framebuffer.begin():console.error(`Cannot begin drawing: framebuffer not initialized for layer ${this.name}`)}end(){this.framebuffer?this.framebuffer.end():console.error(`Cannot end drawing: framebuffer not initialized for layer ${this.name}`)}dispose(){this.framebuffer&&(this.framebuffer.remove(),this.framebuffer=null)}toJSON(){return{id:this.id,name:this.name,visible:this.visible,opacity:this.opacity,blendMode:this.blendMode,zIndex:this.zIndex,hasMask:!!this.mask,width:this.width,height:this.height}}}class i{constructor(e){this.p=e,this.shader=null,this.shaderLoaded=!1}_ensureShader(){if(!this.shaderLoaded)try{this.shader=this.p.createShader("precision highp float;\n\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\n\nvoid main() {\n  // Pass through texture coordinates\n  vTexCoord = aTexCoord;\n\n  // Standard vertex transformation\n  vec4 positionVec4 = vec4(aPosition, 1.0);\n  positionVec4.xy = positionVec4.xy * 2.0 - 1.0;\n  gl_Position = positionVec4;\n}\n","precision highp float;\n\nvarying vec2 vTexCoord;\n\nuniform sampler2D layerTexture;\nuniform sampler2D maskTexture;\nuniform bool hasMask;\nuniform float layerOpacity;\n\nvoid main() {\n  // Flip y-coordinate for p5.js texture coordinate system\n  vec2 uv = vec2(vTexCoord.x, 1.0 - vTexCoord.y);\n\n  // Sample the layer texture\n  vec4 layerColor = texture2D(layerTexture, uv);\n\n  // Calculate final opacity\n  float finalOpacity = layerOpacity;\n\n  // Apply mask if present\n  if (hasMask) {\n    vec4 maskColor = texture2D(maskTexture, uv);\n    // Use the red channel of the mask as alpha (grayscale mask)\n    // Could also use maskColor.a for alpha channel masks\n    float maskValue = maskColor.r;\n    finalOpacity *= maskValue;\n  }\n\n  // Apply opacity to the layer color (including RGB channels for proper alpha blending)\n  // This ensures proper pre-multiplied alpha behavior\n  layerColor.rgb *= finalOpacity;\n  layerColor.a *= finalOpacity;\n\n  gl_FragColor = layerColor;\n}\n"),this.shaderLoaded=!0}catch(e){console.error("Failed to create compositor shader:",e),this.shaderLoaded=!1}return this.shader}_renderLayer(e){if(!e.visible||e.opacity<=0)return;if(!e.framebuffer)return void console.warn(`Layer ${e.name} has no framebuffer, skipping`);const t=this.p;t.push();const a=n(e.blendMode,t);t.blendMode(a),this._renderLayerWithShader(e),t.pop()}_renderLayerWithShader(e){const t=this._ensureShader();if(!t)return void console.warn("Compositor shader not available, rendering without shader");const n=this.p;n.shader(t),t.setUniform("layerTexture",e.framebuffer),t.setUniform("maskTexture",e.mask||e.framebuffer),t.setUniform("hasMask",!!e.mask),t.setUniform("layerOpacity",e.opacity),n.imageMode(n.CENTER),n.rectMode(n.CENTER),n.noStroke(),n.fill(255),n.rect(0,0,n.width,n.height),n.resetShader()}render(e,t=null){const n=this.p;n.push(),t?t():n.clear(),n.resetShader(),n.blendMode(n.BLEND);const a=[...e].sort((e,t)=>e.zIndex-t.zIndex);for(const e of a)this._renderLayer(e);n.blendMode(n.BLEND),n.resetShader(),n.pop()}dispose(){this.shader=null,this.shaderLoaded=!1}}class s{constructor(e,t={}){this.layerSystem=e,this.options={position:t.position||"top-right",width:t.width||280,collapsible:!1!==t.collapsible,draggable:!1!==t.draggable,...t},this.isCollapsed=!1,this.container=null,this.layerElements=new Map,this.draggedLayer=null,this.draggedElement=null,this.dragEnterTimeout=null,this.lastDragTarget=null,this._createUI(),this._attachStyles()}_createUI(){this.container=document.createElement("div"),this.container.className="p5ml-layer-panel",this.container.style.width=`${this.options.width}px`;const e=document.createElement("div");e.className="p5ml-panel-header",e.innerHTML=`\n      <span class="p5ml-panel-title">Layers</span>\n      ${this.options.collapsible?'<button class="p5ml-collapse-btn">âˆ’</button>':""}\n    `,this.container.appendChild(e),this.layersContainer=document.createElement("div"),this.layersContainer.className="p5ml-layers-container",this.container.appendChild(this.layersContainer),document.body.appendChild(this.container),this._positionPanel(),this.options.collapsible&&e.querySelector(".p5ml-collapse-btn").addEventListener("click",()=>this.toggle()),this.options.draggable&&this._makeDraggable(e),document.addEventListener("click",e=>{this.container.contains(e.target)||this._closeAllDropdowns()})}_closeAllDropdowns(){document.querySelectorAll(".p5ml-layer-dropdown").forEach(e=>{e.style.display="none"})}_positionPanel(){const e={"top-right":{top:"20px",right:"20px"},"top-left":{top:"20px",left:"20px"},"bottom-right":{bottom:"20px",right:"20px"},"bottom-left":{bottom:"20px",left:"20px"}},t=e[this.options.position]||e["top-right"];Object.assign(this.container.style,t)}_makeDraggable(e){let t,n,a,r,i=!1;e.style.cursor="move",e.addEventListener("mousedown",e=>{i=!0,a=e.clientX-(parseInt(this.container.style.left)||0),r=e.clientY-(parseInt(this.container.style.top)||0),this.container.style.right="auto",this.container.style.bottom="auto"}),document.addEventListener("mousemove",e=>{i&&(e.preventDefault(),t=e.clientX-a,n=e.clientY-r,this.container.style.left=t+"px",this.container.style.top=n+"px")}),document.addEventListener("mouseup",()=>{i=!1})}update(){const e=this.layerSystem.getLayers();this.layersContainer.innerHTML="",this.layerElements.clear(),[...e].reverse().forEach(e=>{const t=this._createLayerElement(e);this.layersContainer.appendChild(t),this.layerElements.set(e.id,t)}),this._updateThumbnails()}syncState(){this.layerSystem.getLayers().forEach(e=>{const t=this.layerElements.get(e.id);if(!t)return;const n=t.querySelector(".p5ml-visibility-checkbox");n&&(n.checked=e.visible);const a=t.querySelector(".p5ml-opacity-slider"),r=t.querySelector(".p5ml-opacity-value");if(a&&r){const t=Math.round(100*e.opacity);a.value=t,r.textContent=t+"%"}const i=t.querySelector(".p5ml-blend-select"),s=t.querySelector(".p5ml-blend-indicator");i&&(i.value=e.blendMode),s&&(s.textContent=this._getBlendModeLetter(e.blendMode),s.title=`Blend Mode: ${e.blendMode}`)})}_updateThumbnails(){this.layerSystem.getLayers().forEach(e=>{this._updateLayerThumbnail(e.id)})}_updateLayerThumbnail(e){const t=this.layerSystem.getLayers().find(t=>t.id===e);if(!t)return;const n=this.layerElements.get(e);if(!n)return;const a=n.querySelector(".p5ml-thumbnail-canvas");if(!a)return;const r=a.getContext("2d"),i=t.framebuffer;if(i)try{let e;if(this._drawCheckerboard(r,a.width,a.height),"function"==typeof i.get?e=i.get():i.canvas&&(e=i),e&&e.canvas){const t=e.canvas,n=Math.min(a.width/t.width,a.height/t.height),i=t.width*n,s=t.height*n,o=(a.width-i)/2,l=(a.height-s)/2;r.drawImage(t,o,l,i,s)}}catch(e){console.debug("Could not render thumbnail:",e)}}_createLayerElement(e){const n=document.createElement("div");n.className="p5ml-layer-item",n.dataset.layerId=e.id,n.draggable=!0,n.addEventListener("click",t=>{t.target.closest(".p5ml-layer-dropdown")||(t.target.classList.contains("p5ml-layer-row")||t.target.classList.contains("p5ml-layer-name")||t.target.classList.contains("p5ml-layer-thumbnail")||t.target.classList.contains("p5ml-thumbnail-canvas"))&&(this._closeAllDropdowns(),this._updateLayerThumbnail(e.id))}),n.addEventListener("dragstart",t=>this._handleDragStart(t,e)),n.addEventListener("dragend",e=>this._handleDragEnd(e)),n.addEventListener("dragover",e=>this._handleDragOver(e)),n.addEventListener("drop",t=>this._handleDrop(t,e)),n.addEventListener("dragenter",e=>this._handleDragEnter(e)),n.addEventListener("dragleave",e=>this._handleDragLeave(e));const a=document.createElement("div");a.className="p5ml-layer-row";const r=this._createThumbnail();r.className="p5ml-layer-thumbnail",a.appendChild(r);const i=document.createElement("span");i.className="p5ml-layer-name",i.textContent=e.name,a.appendChild(i);const s=document.createElement("div");s.className="p5ml-right-controls";const o=document.createElement("button");o.className="p5ml-blend-indicator",o.textContent=this._getBlendModeLetter(e.blendMode),o.title=`Blend Mode: ${e.blendMode}`,o.addEventListener("click",e=>{e.stopPropagation();const t=n.querySelector(".p5ml-layer-dropdown"),a="block"===t.style.display;this._closeAllDropdowns(),t.style.display=a?"none":"block"});const l=document.createElement("input");l.type="checkbox",l.className="p5ml-visibility-checkbox",l.checked=e.visible,l.title="Toggle visibility",l.addEventListener("change",t=>{t.stopPropagation(),this.layerSystem.setVisible(e.id,t.target.checked)}),s.appendChild(o),s.appendChild(l),a.appendChild(s);const d=document.createElement("div");d.className="p5ml-layer-dropdown",d.style.display="none";const c=document.createElement("div");c.className="p5ml-control-group";const h=document.createElement("label");h.textContent="OPACITY";const p=document.createElement("span");p.className="p5ml-opacity-value",p.textContent=Math.round(100*e.opacity)+"%";const m=document.createElement("input");m.type="range",m.min="0",m.max="100",m.value=Math.round(100*e.opacity),m.className="p5ml-opacity-slider",m.addEventListener("input",t=>{t.stopPropagation();const n=parseFloat(t.target.value)/100;this.layerSystem.setOpacity(e.id,n),p.textContent=t.target.value+"%"}),c.appendChild(h),c.appendChild(p),c.appendChild(m);const u=document.createElement("div");u.className="p5ml-control-group";const g=document.createElement("label");g.textContent="BLEND MODE";const y=document.createElement("select");return y.className="p5ml-blend-select",Object.values(t).forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=this._formatBlendModeName(t),n.selected=e.blendMode===t,y.appendChild(n)}),y.addEventListener("change",t=>{t.stopPropagation(),this.layerSystem.setBlendMode(e.id,t.target.value),o.textContent=this._getBlendModeLetter(t.target.value),o.title=`Blend Mode: ${t.target.value}`}),u.appendChild(g),u.appendChild(y),d.appendChild(c),d.appendChild(u),n.appendChild(a),n.appendChild(d),n}_getBlendModeLetter(e){return{[t.NORMAL]:"N",[t.MULTIPLY]:"M",[t.SCREEN]:"S",[t.OVERLAY]:"O",[t.DARKEN]:"D",[t.LIGHTEN]:"Li",[t.COLOR_DODGE]:"Cd",[t.COLOR_BURN]:"B",[t.HARD_LIGHT]:"HL",[t.SOFT_LIGHT]:"SL",[t.DIFFERENCE]:"Di",[t.EXCLUSION]:"E",[t.ADD]:"A",[t.SUBTRACT]:"Su"}[e]||"-"}_formatBlendModeName(e){return e.split("_").map(e=>e.charAt(0)+e.slice(1).toLowerCase()).join(" ")}_createThumbnail(){const e=document.createElement("div");e.className="p5ml-thumbnail";const t=document.createElement("canvas");t.className="p5ml-thumbnail-canvas",t.width=60,t.height=60;const n=t.getContext("2d");return this._drawCheckerboard(n,t.width,t.height),e.appendChild(t),e}_drawCheckerboard(e,t,n){e.fillStyle="#333",e.fillRect(0,0,t,n),e.fillStyle="#444";for(let a=0;a<n;a+=4)for(let n=0;n<t;n+=4)(n/4+a/4)%2==0&&e.fillRect(n,a,4,4)}_handleDragStart(e,t){e.target.matches("input, select, button, .p5ml-blend-indicator")?e.preventDefault():(this.draggedLayer=t,this.draggedElement=e.currentTarget,requestAnimationFrame(()=>{e.currentTarget.classList.add("p5ml-dragging")}),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.currentTarget.innerHTML),this._closeAllDropdowns())}_handleDragEnd(e){this.dragEnterTimeout&&(clearTimeout(this.dragEnterTimeout),this.dragEnterTimeout=null),e.currentTarget.classList.remove("p5ml-dragging"),document.querySelectorAll(".p5ml-layer-item").forEach(e=>{e.classList.remove("p5ml-drag-over-before","p5ml-drag-over-after","p5ml-drag-placeholder")}),this.draggedLayer=null,this.draggedElement=null,this.lastDragTarget=null}_handleDragOver(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1}_handleDragEnter(e){const t=e.currentTarget;t!==this.draggedElement&&this.lastDragTarget!==t&&(this.dragEnterTimeout&&clearTimeout(this.dragEnterTimeout),this.dragEnterTimeout=setTimeout(()=>{document.querySelectorAll(".p5ml-layer-item").forEach(e=>{e!==this.draggedElement&&e.classList.remove("p5ml-drag-over-before","p5ml-drag-over-after")});const e=Array.from(this.layersContainer.children).indexOf(this.draggedElement);Array.from(this.layersContainer.children).indexOf(t)<e?t.classList.add("p5ml-drag-over-before"):t.classList.add("p5ml-drag-over-after"),this.lastDragTarget=t},50))}_handleDragLeave(e){const t=e.currentTarget,n=e.relatedTarget;t.contains(n)||t.classList.remove("p5ml-drag-over-before","p5ml-drag-over-after")}_handleDrop(e,t){return e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),document.querySelectorAll(".p5ml-layer-item").forEach(e=>{e.classList.remove("p5ml-drag-over-before","p5ml-drag-over-after","p5ml-drag-placeholder")}),this.draggedLayer&&this.draggedLayer.id!==t.id&&this._reorderLayers(this.draggedLayer.id,t.id),!1}_reorderLayers(e,t){const n=this.layerSystem.getLayers(),a=n.findIndex(t=>t.id===e),r=n.findIndex(e=>e.id===t);if(-1===a||-1===r)return;const[i]=n.splice(a,1);n.splice(r,0,i),"function"==typeof this.layerSystem.reorderLayers&&this.layerSystem.reorderLayers(n),this.update()}_attachStyles(){if(document.getElementById("p5ml-layer-ui-styles"))return;const e=document.createElement("style");e.id="p5ml-layer-ui-styles",e.textContent="\n      .p5ml-layer-panel {\n        position: fixed;\n        background: rgba(26, 26, 26, 0.95);\n        border: 1px solid #444;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        font-size: 13px;\n        color: #e0e0e0;\n        z-index: 10000;\n        backdrop-filter: blur(10px);\n        overflow: hidden;\n      }\n\n      .p5ml-layer-panel.collapsed .p5ml-layers-container {\n        display: none;\n      }\n\n      .p5ml-panel-header {\n        background: rgba(60, 60, 60, 0.9);\n        padding: 12px 16px;\n        border-bottom: 1px solid #333;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        user-select: none;\n      }\n\n      .p5ml-panel-title {\n        font-weight: 600;\n        font-size: 16px;\n        letter-spacing: 0.5px;\n        color: #ccc;\n      }\n\n      .p5ml-collapse-btn {\n        background: none;\n        border: none;\n        color: #aaa;\n        font-size: 18px;\n        cursor: pointer;\n        padding: 0;\n        width: 20px;\n        height: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .p5ml-collapse-btn:hover {\n        color: #fff;\n      }\n\n      .p5ml-layers-container {\n        max-height: 500px;\n        overflow-y: auto;\n        padding: 0;\n        background: #2a2a2a;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.2);\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 4px;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      /* Procreate-style layer item */\n      .p5ml-layer-item {\n        background: transparent;\n        border-bottom: 1px solid #3a3a3a;\n        transition:\n          background 0.15s ease,\n          opacity 0.2s ease,\n          transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),\n          margin 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n        cursor: grab;\n        transform-origin: center;\n      }\n\n      .p5ml-layer-item:hover {\n        background: rgba(100, 150, 255, 0.15);\n      }\n\n      .p5ml-layer-item:active {\n        cursor: grabbing;\n      }\n\n      /* Dragging state - shrink and fade */\n      .p5ml-layer-item.p5ml-dragging {\n        opacity: 0.5;\n        transform: scale(0.95);\n        cursor: grabbing;\n        background: rgba(100, 150, 255, 0.08);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      }\n\n      /* Placeholder for dragged item - creates space */\n      .p5ml-layer-item.p5ml-drag-placeholder {\n        opacity: 0.3;\n        transform: scale(0.98);\n        background: rgba(74, 144, 226, 0.05);\n      }\n\n      /* Drag over indicator - shows where item will drop */\n      .p5ml-layer-item.p5ml-drag-over-before {\n        transform: translateY(2px);\n        margin-top: 40px;\n        border-top: 2px solid #4a90e2;\n      }\n\n      .p5ml-layer-item.p5ml-drag-over-after {\n        transform: translateY(-2px);\n        margin-bottom: 40px;\n        border-bottom: 2px solid #4a90e2;\n      }\n\n      /* Main layer row (horizontal layout) */\n      .p5ml-layer-row {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 10px 12px;\n      }\n\n      /* Thumbnail on the left */\n      .p5ml-layer-thumbnail {\n        flex-shrink: 0;\n      }\n\n      .p5ml-layer-thumbnail canvas {\n        display: block;\n        width: 60px;\n        height: 60px;\n        border: 1px solid #555;\n        border-radius: 4px;\n        image-rendering: pixelated;\n      }\n\n      /* Layer name in center */\n      .p5ml-layer-name {\n        flex: 1;\n        font-weight: 500;\n        font-size: 15px;\n        color: #e8e8e8;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      /* Right side controls */\n      .p5ml-right-controls {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        flex-shrink: 0;\n      }\n\n      /* Blend mode letter indicator */\n      .p5ml-blend-indicator {\n        width: 28px;\n        height: 28px;\n        border-radius: 4px;\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        color: #e8e8e8;\n        font-weight: 600;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.15s;\n        pointer-events: auto;\n      }\n\n      .p5ml-blend-indicator:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.3);\n      }\n\n      /* Visibility checkbox */\n      .p5ml-visibility-checkbox {\n        width: 20px;\n        height: 20px;\n        cursor: pointer;\n        accent-color: #4a90e2;\n        pointer-events: auto;\n      }\n\n      /* Dropdown panel for opacity and blend mode */\n      .p5ml-layer-dropdown {\n        background: rgba(40, 40, 40, 0.95);\n        border-top: 1px solid #555;\n        padding: 16px;\n        display: none;\n      }\n\n      .p5ml-control-group {\n        margin-bottom: 16px;\n      }\n\n      .p5ml-control-group:last-child {\n        margin-bottom: 0;\n      }\n\n      .p5ml-control-group label {\n        font-size: 11px;\n        color: #999;\n        text-transform: uppercase;\n        letter-spacing: 0.8px;\n        font-weight: 600;\n        display: flex;\n        justify-content: space-between;\n        margin-bottom: 8px;\n      }\n\n      .p5ml-opacity-value {\n        color: #e0e0e0;\n        font-weight: 600;\n      }\n\n      .p5ml-opacity-slider {\n        width: 100%;\n        height: 6px;\n        border-radius: 3px;\n        outline: none;\n        -webkit-appearance: none;\n        background: rgba(255, 255, 255, 0.15);\n        margin-top: 4px;\n      }\n\n      .p5ml-opacity-slider::-webkit-slider-thumb {\n        -webkit-appearance: none;\n        appearance: none;\n        width: 18px;\n        height: 18px;\n        border-radius: 50%;\n        background: #fff;\n        cursor: pointer;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .p5ml-opacity-slider::-moz-range-thumb {\n        width: 18px;\n        height: 18px;\n        border-radius: 50%;\n        background: #fff;\n        cursor: pointer;\n        border: none;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .p5ml-blend-select {\n        width: 100%;\n        background: rgba(0, 0, 0, 0.4);\n        border: 1px solid #555;\n        border-radius: 6px;\n        color: #e8e8e8;\n        padding: 10px 12px;\n        font-size: 14px;\n        cursor: pointer;\n        outline: none;\n        margin-top: 4px;\n      }\n\n      .p5ml-blend-select:hover {\n        border-color: #777;\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      .p5ml-blend-select option {\n        background: #2a2a2a;\n        color: #e8e8e8;\n        padding: 8px;\n      }\n\n      /* Hide old thumbnail styles - no longer used */\n      .p5ml-thumbnail-label {\n        display: none;\n      }\n    ",document.head.appendChild(e)}toggle(){this.isCollapsed=!this.isCollapsed,this.container.classList.toggle("collapsed",this.isCollapsed);const e=this.container.querySelector(".p5ml-collapse-btn");e&&(e.innerHTML=this.isCollapsed?"+":"âˆ’")}show(){this.container.style.display="block"}hide(){this.container.style.display="none"}dispose(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container)}}class o{constructor(e){if(this.p=e,!this.p._renderer||!this.p._renderer.drawingContext)throw new Error("Canvas not initialized. Make sure createCanvas() is called before createLayerSystem()");if(!(this.p._renderer.drawingContext instanceof WebGLRenderingContext||this.p._renderer.drawingContext instanceof WebGL2RenderingContext))throw new Error("LayerSystem requires WebGL mode. Use createCanvas(w, h, WEBGL)");this.layers=new Map,this.layerIdCounter=0,this.activeLayerId=null,this.compositor=new i(e),this.ui=null,this.autoResize=!0,this._lastCanvasWidth=this.p.width,this._lastCanvasHeight=this.p.height}_generateId(){return this.layerIdCounter++}createLayer(e="",t={}){const n=this._generateId(),a=new r(this.p,n,e,{...t,zIndex:void 0!==t.zIndex?t.zIndex:n});return this.layers.set(n,a),n}removeLayer(e){const t=this.layers.get(e);t?(this.activeLayerId===e&&this.endLayer(),t.dispose(),this.layers.delete(e)):console.warn(`Layer ${e} not found`)}getLayer(e){return this.layers.get(e)||null}getLayers(){return Array.from(this.layers.values()).sort((e,t)=>e.zIndex-t.zIndex)}getLayerInfo(){return this.getLayers().map(e=>e.toJSON())}beginLayer(e){null!==this.activeLayerId&&(console.warn(`Layer ${this.activeLayerId} is already active. Ending it first.`),this.endLayer());const t=this.layers.get(e);t?(t.begin(),this.activeLayerId=e):console.error(`Layer ${e} not found`)}endLayer(){if(null===this.activeLayerId)return void console.warn("No active layer to end");const e=this.layers.get(this.activeLayerId);e&&e.end(),this.activeLayerId=null}setVisible(e,t){const n=this.layers.get(e);n?n.setVisible(t):console.warn(`Layer ${e} not found`)}setOpacity(e,t){const n=this.layers.get(e);n?n.setOpacity(t):console.warn(`Layer ${e} not found`)}setBlendMode(e,t){const n=this.layers.get(e);n?n.setBlendMode(t):console.warn(`Layer ${e} not found`)}setLayerIndex(e,t){const n=this.layers.get(e);n?n.setZIndex(t):console.warn(`Layer ${e} not found`)}moveLayer(e,t){const n=this.layers.get(e);n?n.setZIndex(n.zIndex+t):console.warn(`Layer ${e} not found`)}reorderLayers(e){e.forEach((e,t)=>{e.setZIndex(t)}),this.ui&&this.ui.update()}setMask(e,t){const n=this.layers.get(e);n?n.setMask(t):console.warn(`Layer ${e} not found`)}clearMask(e){const t=this.layers.get(e);t?t.clearMask():console.warn(`Layer ${e} not found`)}render(e=null){this.autoResize&&this._checkResize();const t=this.getLayers();this.compositor.render(t,e),this.ui&&this.ui.syncState()}_checkResize(){if(this.p.width!==this._lastCanvasWidth||this.p.height!==this._lastCanvasHeight){this._lastCanvasWidth=this.p.width,this._lastCanvasHeight=this.p.height;for(const e of this.layers.values())e.customSize||e.resize(this.p.width,this.p.height)}}setAutoResize(e){this.autoResize=!!e}createUI(e={}){return this.ui&&this.ui.dispose(),this.ui=new s(this,e),this.ui.update(),this.ui}updateUI(){this.ui&&this.ui.update()}dispose(){null!==this.activeLayerId&&this.endLayer(),this.ui&&(this.ui.dispose(),this.ui=null);for(const e of this.layers.values())e.dispose();this.layers.clear(),this.compositor.dispose()}}!function(){if("undefined"!=typeof __BUILD_TIMESTAMP__){const e=new Date(__BUILD_TIMESTAMP__),t=new Date-e,n=e.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),a=e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});let r;const i=Math.floor(t/1e3),s=Math.floor(i/60),o=Math.floor(s/60),l=Math.floor(o/24);r=l>0?`${l} day${1!==l?"s":""} ago`:o>0?`${o} hour${1!==o?"s":""} ago`:s>0?`${s} minute${1!==s?"s":""} ago`:`${i} second${1!==i?"s":""} ago`;const d=new Intl.DateTimeFormat("en-US",{timeZoneName:"short"}).formatToParts(e).find(e=>"timeZoneName"===e.type)?.value||"";console.log(`ðŸ“… Last updated on ${n} at ${a}${d?" "+d:""} (${r})`)}}(),e.BlendModes=t,e.Compositor=i,e.DEFAULT_LAYER_OPTIONS=a,e.Layer=r,e.LayerSystem=o,e.LayerUI=s,e.VERSION="0.1.0",e.createLayerSystem=function(e){let t=e;if(!t||t===window)if("undefined"!=typeof window&&window.p5&&window.p5.instance)t=window.p5.instance;else if("undefined"!=typeof window&&window._renderer)t=window;else{if("undefined"==typeof window||"function"!=typeof window.createCanvas)throw new Error("p5.js instance not found. Make sure p5.js is loaded and createCanvas() has been called.");t=window}if(!t)throw new Error("p5.js instance not found. Pass the p5 instance to createLayerSystem()");return new o(t)},e.getP5BlendMode=n});