!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).p5Millefeuille={})}(this,function(e){"use strict";const n={NORMAL:"NORMAL",MULTIPLY:"MULTIPLY",SCREEN:"SCREEN",ADD:"ADD",SUBTRACT:"SUBTRACT",OVERLAY:"OVERLAY",SOFT_LIGHT:"SOFT_LIGHT",HARD_LIGHT:"HARD_LIGHT",COLOR_DODGE:"COLOR_DODGE",COLOR_BURN:"COLOR_BURN",DARKEN:"DARKEN",LIGHTEN:"LIGHTEN",DIFFERENCE:"DIFFERENCE",EXCLUSION:"EXCLUSION"};function t(e){switch(e){case n.NORMAL:return 0;case n.MULTIPLY:return 1;case n.SCREEN:return 2;case n.ADD:return 3;case n.SUBTRACT:return 4;case n.OVERLAY:return 5;case n.SOFT_LIGHT:return 6;case n.HARD_LIGHT:return 7;case n.COLOR_DODGE:return 8;case n.COLOR_BURN:return 9;case n.DARKEN:return 10;case n.LIGHTEN:return 11;case n.DIFFERENCE:return 12;case n.EXCLUSION:return 13;default:return console.warn(`Unknown blend mode: ${e}, falling back to NORMAL`),0}}const a={visible:!0,opacity:1,blendMode:n.NORMAL,width:null,height:null,density:null,depth:!1,antialias:!1};class i{constructor(e,n,t="",i={}){this.p=e,this.id=n,this.name=t||`Layer ${n}`;const r={...a,...i};if(this.visible=r.visible,this.opacity=this._clampOpacity(r.opacity),this.blendMode=r.blendMode,this.zIndex=void 0!==r.zIndex?r.zIndex:n,this.width=r.width||this.p.width,this.height=r.height||this.p.height,this.density=r.density||this.p.pixelDensity(),this.depth=r.depth,this.antialias=r.antialias,this.mask=null,this.hasBeenDrawnTo=!1,this.framebuffer=this._createFramebuffer(),!this.framebuffer)throw new Error(`Failed to create framebuffer for layer ${this.name}`)}_createFramebuffer(){try{const e={width:this.width,height:this.height,density:this.density};return void 0!==this.depth&&(e.depth=this.depth),void 0!==this.antialias&&(e.antialias=this.antialias),this.p.createFramebuffer(e)}catch(e){return console.error(`Error creating framebuffer for layer ${this.name}:`,e),null}}_clampOpacity(e){return Math.max(0,Math.min(1,e))}show(){return this.visible=!0,this}hide(){return this.visible=!1,this}setOpacity(e){return this.opacity=this._clampOpacity(e),this}setBlendMode(e){return Object.values(n).includes(e)?this.blendMode=e:(console.warn(`Invalid blend mode: ${e}, using NORMAL`),this.blendMode=n.NORMAL),this}setZIndex(e){return this.zIndex=e,this}setMask(e){return e?(this.mask=e,this):(console.warn("Invalid mask source provided"),this)}clearMask(){return this.mask=null,this}resize(e,n){this.width=e,this.height=n,this.framebuffer&&this.framebuffer.remove(),this.framebuffer=this._createFramebuffer()}begin(){this.framebuffer?this.framebuffer.begin():console.error(`Cannot begin drawing: framebuffer not initialized for layer ${this.name}`)}end(){this.framebuffer?(this.framebuffer.end(),this.hasBeenDrawnTo=!0):console.error(`Cannot end drawing: framebuffer not initialized for layer ${this.name}`)}dispose(){this.framebuffer&&(this.framebuffer.remove(),this.framebuffer=null)}toJSON(){return{id:this.id,name:this.name,visible:this.visible,opacity:this.opacity,blendMode:this.blendMode,zIndex:this.zIndex,hasMask:!!this.mask,hasBeenDrawnTo:this.hasBeenDrawnTo,width:this.width,height:this.height}}}class r{constructor(e){this.p=e,this.shader=null,this.shaderLoaded=!1,this.bufferA=null,this.bufferB=null}_ensureShader(){if(!this.shaderLoaded)try{this.shader=this.p.createShader("precision highp float;\n#define GLSLIFY 1\n\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\n\nvoid main() {\n  // Pass through texture coordinates\n  vTexCoord = aTexCoord;\n\n  // Standard vertex transformation\n  vec4 positionVec4 = vec4(aPosition, 1.0);\n  positionVec4.xy = positionVec4.xy * 2.0 - 1.0;\n  gl_Position = positionVec4;\n}\n","precision highp float;\n#define GLSLIFY 1\n\nvarying vec2 vTexCoord;\n\nuniform sampler2D layerTexture;\nuniform sampler2D backgroundTexture;\nuniform sampler2D maskTexture;\nuniform bool hasMask;\nuniform float layerOpacity;\nuniform int blendMode;\n\n// Import glsl-blend functions\nvec3 blendNormal(vec3 base, vec3 blend) {\n\treturn blend;\n}\n\nvec3 blendNormal(vec3 base, vec3 blend, float opacity) {\n\treturn (blendNormal(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nvec3 blendMultiply(vec3 base, vec3 blend) {\n\treturn base*blend;\n}\n\nvec3 blendMultiply(vec3 base, vec3 blend, float opacity) {\n\treturn (blendMultiply(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendScreen(float base, float blend) {\n\treturn 1.0-((1.0-base)*(1.0-blend));\n}\n\nvec3 blendScreen(vec3 base, vec3 blend) {\n\treturn vec3(blendScreen(base.r,blend.r),blendScreen(base.g,blend.g),blendScreen(base.b,blend.b));\n}\n\nvec3 blendScreen(vec3 base, vec3 blend, float opacity) {\n\treturn (blendScreen(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendAdd(float base, float blend) {\n\treturn min(base+blend,1.0);\n}\n\nvec3 blendAdd(vec3 base, vec3 blend) {\n\treturn min(base+blend,vec3(1.0));\n}\n\nvec3 blendAdd(vec3 base, vec3 blend, float opacity) {\n\treturn (blendAdd(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendSubtract(float base, float blend) {\n\treturn max(base+blend-1.0,0.0);\n}\n\nvec3 blendSubtract(vec3 base, vec3 blend) {\n\treturn max(base+blend-vec3(1.0),vec3(0.0));\n}\n\nvec3 blendSubtract(vec3 base, vec3 blend, float opacity) {\n\treturn (blendSubtract(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendOverlay_0(float base, float blend) {\n\treturn base<0.5?(2.0*base*blend):(1.0-2.0*(1.0-base)*(1.0-blend));\n}\n\nvec3 blendOverlay_0(vec3 base, vec3 blend) {\n\treturn vec3(blendOverlay_0(base.r,blend.r),blendOverlay_0(base.g,blend.g),blendOverlay_0(base.b,blend.b));\n}\n\nvec3 blendOverlay_0(vec3 base, vec3 blend, float opacity) {\n\treturn (blendOverlay_0(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendSoftLight(float base, float blend) {\n\treturn (blend<0.5)?(2.0*base*blend+base*base*(1.0-2.0*blend)):(sqrt(base)*(2.0*blend-1.0)+2.0*base*(1.0-blend));\n}\n\nvec3 blendSoftLight(vec3 base, vec3 blend) {\n\treturn vec3(blendSoftLight(base.r,blend.r),blendSoftLight(base.g,blend.g),blendSoftLight(base.b,blend.b));\n}\n\nvec3 blendSoftLight(vec3 base, vec3 blend, float opacity) {\n\treturn (blendSoftLight(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendOverlay_1(float base, float blend) {\n\treturn base<0.5?(2.0*base*blend):(1.0-2.0*(1.0-base)*(1.0-blend));\n}\n\nvec3 blendOverlay_1(vec3 base, vec3 blend) {\n\treturn vec3(blendOverlay_1(base.r,blend.r),blendOverlay_1(base.g,blend.g),blendOverlay_1(base.b,blend.b));\n}\n\nvec3 blendOverlay_1(vec3 base, vec3 blend, float opacity) {\n\treturn (blendOverlay_1(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nvec3 blendHardLight(vec3 base, vec3 blend) {\n\treturn blendOverlay_1(blend,base);\n}\n\nvec3 blendHardLight(vec3 base, vec3 blend, float opacity) {\n\treturn (blendHardLight(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendColorDodge(float base, float blend) {\n\treturn (blend==1.0)?blend:min(base/(1.0-blend),1.0);\n}\n\nvec3 blendColorDodge(vec3 base, vec3 blend) {\n\treturn vec3(blendColorDodge(base.r,blend.r),blendColorDodge(base.g,blend.g),blendColorDodge(base.b,blend.b));\n}\n\nvec3 blendColorDodge(vec3 base, vec3 blend, float opacity) {\n\treturn (blendColorDodge(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendColorBurn(float base, float blend) {\n\treturn (blend==0.0)?blend:max((1.0-((1.0-base)/blend)),0.0);\n}\n\nvec3 blendColorBurn(vec3 base, vec3 blend) {\n\treturn vec3(blendColorBurn(base.r,blend.r),blendColorBurn(base.g,blend.g),blendColorBurn(base.b,blend.b));\n}\n\nvec3 blendColorBurn(vec3 base, vec3 blend, float opacity) {\n\treturn (blendColorBurn(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendDarken(float base, float blend) {\n\treturn min(blend,base);\n}\n\nvec3 blendDarken(vec3 base, vec3 blend) {\n\treturn vec3(blendDarken(base.r,blend.r),blendDarken(base.g,blend.g),blendDarken(base.b,blend.b));\n}\n\nvec3 blendDarken(vec3 base, vec3 blend, float opacity) {\n\treturn (blendDarken(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nfloat blendLighten(float base, float blend) {\n\treturn max(blend,base);\n}\n\nvec3 blendLighten(vec3 base, vec3 blend) {\n\treturn vec3(blendLighten(base.r,blend.r),blendLighten(base.g,blend.g),blendLighten(base.b,blend.b));\n}\n\nvec3 blendLighten(vec3 base, vec3 blend, float opacity) {\n\treturn (blendLighten(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nvec3 blendDifference(vec3 base, vec3 blend) {\n\treturn abs(base-blend);\n}\n\nvec3 blendDifference(vec3 base, vec3 blend, float opacity) {\n\treturn (blendDifference(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nvec3 blendExclusion(vec3 base, vec3 blend) {\n\treturn base+blend-2.0*base*blend;\n}\n\nvec3 blendExclusion(vec3 base, vec3 blend, float opacity) {\n\treturn (blendExclusion(base, blend) * opacity + base * (1.0 - opacity));\n}\n\nvec3 applyBlendMode(int mode, vec3 base, vec3 blend, float opacity) {\n  if (mode == 0) return blendNormal(base, blend, opacity);      // NORMAL\n  if (mode == 1) return blendMultiply(base, blend, opacity);    // MULTIPLY\n  if (mode == 2) return blendScreen(base, blend, opacity);      // SCREEN\n  if (mode == 3) return blendAdd(base, blend, opacity);         // ADD\n  if (mode == 4) return blendSubtract(base, blend, opacity);    // SUBTRACT\n  if (mode == 5) return blendOverlay_0(base, blend, opacity);     // OVERLAY\n  if (mode == 6) return blendSoftLight(base, blend, opacity);   // SOFT_LIGHT\n  if (mode == 7) return blendHardLight(base, blend, opacity);   // HARD_LIGHT\n  if (mode == 8) return blendColorDodge(base, blend, opacity);  // COLOR_DODGE\n  if (mode == 9) return blendColorBurn(base, blend, opacity);   // COLOR_BURN\n  if (mode == 10) return blendDarken(base, blend, opacity);     // DARKEN\n  if (mode == 11) return blendLighten(base, blend, opacity);    // LIGHTEN\n  if (mode == 12) return blendDifference(base, blend, opacity); // DIFFERENCE\n  if (mode == 13) return blendExclusion(base, blend, opacity);  // EXCLUSION\n  return blendNormal(base, blend, opacity); // Fallback\n}\n\nvoid main() {\n  // Use texture coordinates directly\n  vec2 uv = vTexCoord;\n\n  // Sample textures\n  vec4 layerColor = texture2D(layerTexture, uv);\n  vec4 bgColor = texture2D(backgroundTexture, uv);\n\n  // Calculate final opacity from layer alpha and opacity uniform\n  float finalOpacity = layerColor.a * layerOpacity;\n\n  // Apply mask if present\n  if (hasMask) {\n    vec4 maskColor = texture2D(maskTexture, uv);\n    float maskValue = maskColor.r;\n    finalOpacity *= maskValue;\n  }\n\n  // If layer is completely transparent, just output background\n  if (finalOpacity <= 0.0) {\n    gl_FragColor = bgColor;\n    return;\n  }\n\n  // Apply blend mode only where layer has content\n  vec3 blendedColor = applyBlendMode(blendMode, bgColor.rgb, layerColor.rgb, finalOpacity);\n\n  // Output with proper alpha compositing\n  gl_FragColor = vec4(blendedColor, 1.0);\n}\n"),this.shaderLoaded=!0}catch(e){console.error("Failed to create compositor shader:",e),this.shaderLoaded=!1}return this.shader}_ensureBuffers(){const e=this.p;if(!this.bufferA||this.bufferA.width!==e.width||this.bufferA.height!==e.height){this.bufferA&&(this.bufferA.remove(),this.bufferB.remove());const n={width:e.width,height:e.height,density:e.pixelDensity(),antialias:!1,depth:!1};this.bufferA=e.createFramebuffer(n),this.bufferB=e.createFramebuffer(n)}return{a:this.bufferA,b:this.bufferB}}_renderLayer(e,n){if(!e.visible||e.opacity<=0)return;if(!e.framebuffer)return void console.warn(`Layer ${e.name} has no framebuffer, skipping`);const a=this._ensureShader();if(!a)return void console.warn("Compositor shader not available, skipping layer");const i=this.p;i.push(),i.blendMode(i.BLEND),i.shader(a),a.setUniform("layerTexture",e.framebuffer),a.setUniform("backgroundTexture",n),a.setUniform("maskTexture",e.mask||e.framebuffer),a.setUniform("hasMask",!!e.mask),a.setUniform("layerOpacity",e.opacity),a.setUniform("blendMode",t(e.blendMode)),i.imageMode(i.CENTER),i.rectMode(i.CENTER),i.noStroke(),i.fill(255),i.rect(0,0,i.width,i.height),i.resetShader(),i.pop()}render(e,n=null){const t=this.p,a=this._ensureBuffers();let i=a.a,r=a.b;const l=[...e].sort((e,n)=>e.zIndex-n.zIndex);i.begin(),t.clear(),i.end();for(let e=0;e<l.length;e++){const n=l[e];if(!n.visible||n.opacity<=0)continue;r.begin(),t.clear(),this._renderLayer(n,i),r.end();const a=i;i=r,r=a}t.push(),n?n():t.clear(),t.resetShader(),t.blendMode(t.BLEND),t.imageMode(t.CENTER),t.image(i,0,0),t.pop()}dispose(){this.bufferA&&(this.bufferA.remove(),this.bufferA=null),this.bufferB&&(this.bufferB.remove(),this.bufferB=null),this.shader=null,this.shaderLoaded=!1}}class l{constructor(e,n={}){if(this.layerSystem=e,this.options={...n,position:n.position||"top-right",width:n.width||280,collapsible:!1!==n.collapsible,draggable:!1!==n.draggable,thumbnailPadding:n.thumbnailPadding??4,thumbnailSampleMaxSize:n.thumbnailSampleMaxSize??196,thumbnailAlphaThreshold:n.thumbnailAlphaThreshold??12,thumbnailAnimationWindow:n.thumbnailAnimationWindow??6,thumbnailEmptyFrameReset:n.thumbnailEmptyFrameReset??6,thumbnailSampleStride:n.thumbnailSampleStride??1},this.isCollapsed=!1,this.container=null,this.layerElements=new Map,this.selectedLayerId=null,this._dirtyThumbnailLayerIds=new Set,this._captureNeeded=new Set,this._thumbnailCache=new Map,this._thumbnailFlushHandle=null,this._cancelThumbnailFlush=null,this._thumbnailBatchSize=1,this._thumbnailIdleBudgetMs=8,this._thumbnailScratchCanvas="undefined"!=typeof document?document.createElement("canvas"):null,this._thumbnailScratchCtx=this._thumbnailScratchCanvas?this._thumbnailScratchCanvas.getContext("2d"):null,this._thumbnailScratchCtx&&(this._thumbnailScratchCtx.imageSmoothingEnabled=!1),this._checkerPatternCanvas="undefined"!=typeof document?document.createElement("canvas"):null,this._checkerPatternCache="undefined"!=typeof WeakMap?new WeakMap:null,this._checkerPatternCanvas){const e=8;this._checkerPatternCanvas.width=e,this._checkerPatternCanvas.height=e;const n=this._checkerPatternCanvas.getContext("2d");n&&(n.fillStyle="#333",n.fillRect(0,0,e,e),n.fillStyle="#444",n.fillRect(0,0,e/2,e/2),n.fillRect(e/2,e/2,e/2,e/2))}this._createUI(),this._attachStyles()}_createUI(){this.container=document.createElement("div"),this.container.className="p5ml-layer-panel",this.container.style.width=`${this.options.width}px`;const e=document.createElement("div");e.className="p5ml-panel-header",e.innerHTML=`\n      <span class="p5ml-panel-title">Layers</span>\n      <div class="p5ml-header-controls">\n        <button class="p5ml-arrow-btn p5ml-arrow-up" title="Move layer up">↑</button>\n        <button class="p5ml-arrow-btn p5ml-arrow-down" title="Move layer down">↓</button>\n        ${this.options.collapsible?'<button class="p5ml-collapse-btn">−</button>':""}\n      </div>\n    `,this.container.appendChild(e),this.layersContainer=document.createElement("div"),this.layersContainer.className="p5ml-layers-container",this.container.appendChild(this.layersContainer),document.body.appendChild(this.container),this._positionPanel();const n=this.layerSystem.p._removeSignal;if(this.options.collapsible){const t=e.querySelector(".p5ml-collapse-btn");t.addEventListener("click",()=>this.toggle(),{signal:n}),t.addEventListener("mousedown",e=>e.stopPropagation(),{signal:n})}const t=e.querySelector(".p5ml-arrow-up"),a=e.querySelector(".p5ml-arrow-down");t.addEventListener("click",()=>this._moveSelectedLayer(-1),{signal:n}),a.addEventListener("click",()=>this._moveSelectedLayer(1),{signal:n}),t.addEventListener("mousedown",e=>e.stopPropagation(),{signal:n}),a.addEventListener("mousedown",e=>e.stopPropagation(),{signal:n}),this.options.draggable&&this._makeDraggable(e),document.addEventListener("click",e=>{this.container.contains(e.target)||(this._closeAllDropdowns(),this._deselectLayer())},{signal:n}),document.addEventListener("keydown",e=>{"ArrowUp"!==e.key&&"ArrowDown"!==e.key||e.repeat||null===this.selectedLayerId||this._isPanelVisible()&&(e.target.matches("input, select, textarea")||(e.preventDefault(),this._moveSelectedLayer("ArrowUp"===e.key?-1:1)))},{signal:n})}_closeAllDropdowns(){document.querySelectorAll(".p5ml-layer-dropdown").forEach(e=>{e.style.display="none"})}_positionPanel(){const e={"top-right":{top:"20px",right:"20px"},"top-left":{top:"20px",left:"20px"},"bottom-right":{bottom:"20px",right:"20px"},"bottom-left":{bottom:"20px",left:"20px"}},n=e[this.options.position]||e["top-right"];Object.assign(this.container.style,n)}_isPanelVisible(){return!(!this.container||"none"===this.container.style.display)&&this.container.getClientRects().length>0}_makeDraggable(e){let n,t,a=!1;e.style.cursor="move";const i=this.layerSystem.p._removeSignal;e.addEventListener("mousedown",e=>{const i=this.container.getBoundingClientRect();n=e.clientX-i.left,t=e.clientY-i.top,a=!0,this.container.style.right="",this.container.style.bottom="",this.container.style.left=i.left+"px",this.container.style.top=i.top+"px"}),document.addEventListener("mousemove",e=>{if(a){e.preventDefault();let a=e.clientX-n,i=e.clientY-t;const r=this.container.offsetWidth,l=window.innerWidth,s=window.innerHeight,o=50;a=Math.max(-r+o,Math.min(a,l-o)),i=Math.max(0,Math.min(i,s-o)),this.container.style.left=a+"px",this.container.style.top=i+"px"}},{signal:i}),document.addEventListener("mouseup",()=>{a=!1},{signal:i})}update(){const e=this.layerSystem.getLayers();this._pruneThumbnailState(e),this.layersContainer.innerHTML="",this.layerElements.clear();const n=[...e].reverse();n.forEach(e=>{const n=this._createLayerElement(e);this.layersContainer.appendChild(n),this.layerElements.set(e.id,n)}),this._markThumbnailsDirty(n.map(e=>e.id),{needsCapture:!0})}scheduleThumbnailUpdate(e,n={}){this._markThumbnailsDirty([e],n)}syncState(){this.layerSystem.getLayers().forEach(e=>{const n=this.layerElements.get(e.id);if(!n)return;const t=n.querySelector(".p5ml-visibility-checkbox");t&&(t.checked=e.visible);const a=n.querySelector(".p5ml-opacity-slider"),i=n.querySelector(".p5ml-opacity-value");if(a&&i){const n=Math.round(100*e.opacity);a.value=n,i.textContent=n+"%"}const r=n.querySelector(".p5ml-blend-select"),l=n.querySelector(".p5ml-blend-indicator");r&&(r.value=e.blendMode),l&&(l.textContent=this._getBlendModeLetter(e.blendMode),l.title=`Blend Mode: ${e.blendMode}`)})}_markThumbnailsDirty(e=[],n={}){const t=Array.isArray(e)?e:[e],a=!!n.needsCapture;t.forEach(e=>{null!=e&&(this._dirtyThumbnailLayerIds.add(e),a&&this._captureNeeded.add(e))}),this._scheduleThumbnailFlush()}_pruneThumbnailState(e){const n=new Set(e.map(e=>e.id));for(const e of Array.from(this._thumbnailCache.keys()))n.has(e)||this._thumbnailCache.delete(e);for(const e of Array.from(this._captureNeeded))n.has(e)||this._captureNeeded.delete(e);for(const e of Array.from(this._dirtyThumbnailLayerIds))n.has(e)||this._dirtyThumbnailLayerIds.delete(e)}_flushDirtyThumbnails(e){if(0===this._dirtyThumbnailLayerIds.size)return;const n="undefined"!=typeof performance&&"function"==typeof performance.now,t=n?performance.now():null,a=e&&"function"==typeof e.timeRemaining?()=>e.timeRemaining():()=>{if(!n||null===t)return Number.POSITIVE_INFINITY;const e=performance.now()-t;return Math.max(0,this._thumbnailIdleBudgetMs-e)},i=()=>a()<=1;let r=0;for(;this._dirtyThumbnailLayerIds.size>0&&!(r>=this._thumbnailBatchSize);){const e=this._dirtyThumbnailLayerIds.values().next();if(e.done)break;const n=e.value;if(this._dirtyThumbnailLayerIds.delete(n),this._updateLayerThumbnail(n),r++,i())break}}_scheduleThumbnailFlush(){if(null!==this._thumbnailFlushHandle||0===this._dirtyThumbnailLayerIds.size)return;const e=e=>{this._thumbnailFlushHandle=null,this._cancelThumbnailFlush=null,this._flushDirtyThumbnails(e),this._dirtyThumbnailLayerIds.size>0&&this._scheduleThumbnailFlush()};"undefined"!=typeof window&&"function"==typeof window.requestIdleCallback?(this._thumbnailFlushHandle=window.requestIdleCallback(e),this._cancelThumbnailFlush=e=>window.cancelIdleCallback(e)):"undefined"!=typeof window&&"function"==typeof window.requestAnimationFrame?(this._thumbnailFlushHandle=window.requestAnimationFrame(()=>e()),this._cancelThumbnailFlush=e=>window.cancelAnimationFrame(e)):(this._thumbnailFlushHandle=setTimeout(()=>e(),16),this._cancelThumbnailFlush=e=>clearTimeout(e))}_updateLayerThumbnail(e){const n=this.layerSystem.getLayers().find(n=>n.id===e);if(!n)return;const t=this.layerElements.get(e);if(!t)return;const a=t.querySelector(".p5ml-thumbnail-canvas");if(!a)return;const i=a.getContext("2d");if(!i)return;const r=this._getOrCreateThumbnailCacheEntry(e);let l=r.image&&r.image.canvas?r.image.canvas:null;if(this._captureNeeded.has(e)||!l){const t=this._captureLayerImage(n);t&&t.canvas&&(r.image=t,l=t.canvas,r.boundsDirty=!0,this._captureNeeded.delete(e))}if(!l)return;const s=r.lastSourceSize;if(s&&s.width===l.width&&s.height===l.height||(r.window=[]),r.lastSourceSize={width:l.width,height:l.height},!this._thumbnailScratchCtx||!r.boundsDirty&&r.drawBounds)r.drawBounds||(r.drawBounds=this._createFullBounds(l),r.boundsDirty=!1);else{const e=this._calculateBoundsFromCanvas(l);this._applyBoundsToCache(r,e,l),r.boundsDirty=!1}const o=r.drawBounds||this._createFullBounds(l),d=this._getCropAmount(l,o);this._drawCheckerboard(i,a.width,a.height,d),this._drawThumbnailImage(i,a,l,o)}_getOrCreateThumbnailCacheEntry(e){return this._thumbnailCache.has(e)||this._thumbnailCache.set(e,{image:null,boundsDirty:!1,window:[],emptyFrames:0,drawBounds:null,lastSourceSize:null}),this._thumbnailCache.get(e)}_captureLayerImage(e){const n=e.framebuffer;if(!n)return null;try{if("function"==typeof n.get)return n.get();if(n.canvas)return n}catch(e){console.debug("Could not capture thumbnail:",e)}return null}_calculateBoundsFromCanvas(e){if(!this._thumbnailScratchCtx||!e.width||!e.height)return null;const n=Math.max(1,this.options.thumbnailSampleMaxSize),t=Math.max(e.width,e.height),a=t>n?n/t:1,i=Math.max(1,Math.round(e.width*a)),r=Math.max(1,Math.round(e.height*a));this._thumbnailScratchCanvas.width=i,this._thumbnailScratchCanvas.height=r;const l=this._thumbnailScratchCtx;let s;l.clearRect(0,0,i,r),l.drawImage(e,0,0,i,r);try{s=l.getImageData(0,0,i,r)}catch(e){return console.debug("Could not read thumbnail buffer:",e),null}const o=function(e,n,t,a={}){const i=Number.isFinite(a.alphaThreshold)?a.alphaThreshold:8,r=Number.isFinite(a.stride)&&a.stride>0?Math.floor(a.stride):1;let l=n,s=t,o=-1,d=-1;for(let a=0;a<t;a+=r){const t=a*n*4;for(let h=0;h<n;h+=r)e[t+4*h+3]>i&&(h<l&&(l=h),a<s&&(s=a),h>o&&(o=h),a>d&&(d=a))}return-1===o||-1===d?null:{x:l,y:s,width:o-l+1,height:d-s+1}}(s.data,i,r,{alphaThreshold:this.options.thumbnailAlphaThreshold,stride:this.options.thumbnailSampleStride});if(!o)return null;const d=e.width/i,h=e.height/r;return{x:o.x*d,y:o.y*h,width:o.width*d,height:o.height*h}}_applyBoundsToCache(e,n,t){if(!e)return;if(e.window||(e.window=[]),n){e.window.push(n);const t=Math.max(1,this.options.thumbnailAnimationWindow||0);for(;e.window.length>t;)e.window.shift();e.emptyFrames=0}else{const n=Math.max(1,this.options.thumbnailEmptyFrameReset||0);e.emptyFrames=(e.emptyFrames||0)+1,e.emptyFrames>=n&&(e.window=[],e.emptyFrames=n)}const a=function(e){if(!Array.isArray(e)||0===e.length)return null;let n=Number.POSITIVE_INFINITY,t=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,r=!1;for(const l of e)l&&(r=!0,l.x<n&&(n=l.x),l.y<t&&(t=l.y),l.x+l.width>a&&(a=l.x+l.width),l.y+l.height>i&&(i=l.y+l.height));return r?{x:n,y:t,width:Math.max(0,a-n),height:Math.max(0,i-t)}:null}(e.window),i=a?function(e,n,t,a){return e?function(e,n,t){if(!e)return null;const a=Math.max(0,Math.min(e.x,n)),i=Math.max(0,Math.min(e.y,t));return{x:a,y:i,width:Math.max(0,Math.min(e.width,n-a)),height:Math.max(0,Math.min(e.height,t-i))}}({x:e.x-n,y:e.y-n,width:e.width+2*n,height:e.height+2*n},t,a):null}(a,this.options.thumbnailPadding,t.width,t.height):null;i&&i.width>0&&i.height>0?e.drawBounds=i:e.drawBounds||(e.drawBounds=this._createFullBounds(t)),e.window.length||(e.drawBounds=this._createFullBounds(t))}_createFullBounds(e){return{x:0,y:0,width:e.width||0,height:e.height||0}}_getCropAmount(e,n){if(!e||!n||n.width<=0||n.height<=0)return 0;const t=(e.width||1)*(e.height||1),a=n.width*n.height;return!Number.isFinite(t)||t<=0?0:1-Math.max(0,Math.min(1,a/t))}_drawThumbnailImage(e,n,t,a){if(!a||a.width<=0||a.height<=0)return;const i=Math.min(n.width/a.width,n.height/a.height),r=Math.max(1,a.width*i),l=Math.max(1,a.height*i),s=(n.width-r)/2,o=(n.height-l)/2;e.save(),e.imageSmoothingEnabled=!1,e.drawImage(t,a.x,a.y,a.width,a.height,s,o,r,l),e.restore()}_createLayerElement(e){const t=document.createElement("div");t.className="p5ml-layer-item",t.dataset.layerId=e.id;const a=this.layerSystem.p._removeSignal;t.addEventListener("click",n=>{(n.target.classList.contains("p5ml-layer-row")||n.target.classList.contains("p5ml-layer-name")||n.target.classList.contains("p5ml-layer-thumbnail")||n.target.classList.contains("p5ml-thumbnail-canvas"))&&(this._closeAllDropdowns(),this._selectLayer(e.id),this._updateLayerThumbnail(e.id))},{signal:a});const i=document.createElement("div");i.className="p5ml-layer-row";const r=this._createThumbnail();r.className="p5ml-layer-thumbnail",i.appendChild(r);const l=document.createElement("span");l.className="p5ml-layer-name",l.textContent=e.name,i.appendChild(l);const s=document.createElement("div");s.className="p5ml-right-controls";const o=document.createElement("button");o.className="p5ml-blend-indicator",o.textContent=this._getBlendModeLetter(e.blendMode),o.title=`Blend Mode: ${e.blendMode}`,o.addEventListener("click",e=>{e.stopPropagation();const n=t.querySelector(".p5ml-layer-dropdown"),a="block"===n.style.display;this._closeAllDropdowns(),n.style.display=a?"none":"block"},{signal:a});const d=document.createElement("input");d.type="checkbox",d.className="p5ml-visibility-checkbox",d.checked=e.visible,d.title="Toggle visibility",d.addEventListener("change",n=>{n.stopPropagation(),n.target.checked?this.layerSystem.show(e.id):this.layerSystem.hide(e.id)},{signal:a}),s.appendChild(o),s.appendChild(d),i.appendChild(s);const h=document.createElement("div");h.className="p5ml-layer-dropdown",h.style.display="none";const c=document.createElement("div");c.className="p5ml-control-group";const u=document.createElement("label");u.textContent="OPACITY";const b=document.createElement("span");b.className="p5ml-opacity-value",b.textContent=Math.round(100*e.opacity)+"%";const p=document.createElement("input");p.type="range",p.min="0",p.max="100",p.value=Math.round(100*e.opacity),p.className="p5ml-opacity-slider",p.addEventListener("input",n=>{n.stopPropagation();const t=parseFloat(n.target.value)/100;this.layerSystem.setOpacity(e.id,t),b.textContent=n.target.value+"%"},{signal:a}),c.appendChild(u),c.appendChild(b),c.appendChild(p);const m=document.createElement("div");m.className="p5ml-control-group";const y=document.createElement("label");y.textContent="BLEND MODE";const f=document.createElement("select");return f.className="p5ml-blend-select",Object.values(n).forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=this._formatBlendModeName(n),t.selected=e.blendMode===n,f.appendChild(t)}),f.addEventListener("change",n=>{n.stopPropagation(),this.layerSystem.setBlendMode(e.id,n.target.value),o.textContent=this._getBlendModeLetter(n.target.value),o.title=`Blend Mode: ${n.target.value}`},{signal:a}),m.appendChild(y),m.appendChild(f),h.appendChild(c),h.appendChild(m),t.appendChild(i),t.appendChild(h),t}_getBlendModeLetter(e){return{[n.NORMAL]:"N",[n.MULTIPLY]:"M",[n.SCREEN]:"S",[n.OVERLAY]:"O",[n.DARKEN]:"D",[n.LIGHTEN]:"Li",[n.COLOR_DODGE]:"Cd",[n.COLOR_BURN]:"B",[n.HARD_LIGHT]:"HL",[n.SOFT_LIGHT]:"SL",[n.DIFFERENCE]:"Di",[n.EXCLUSION]:"E",[n.ADD]:"A",[n.SUBTRACT]:"Su"}[e]||"-"}_formatBlendModeName(e){return e.split("_").map(e=>e.charAt(0)+e.slice(1).toLowerCase()).join(" ")}_createThumbnail(){const e=document.createElement("div");e.className="p5ml-thumbnail";const n=document.createElement("canvas");n.className="p5ml-thumbnail-canvas",n.width=60,n.height=60;const t=n.getContext("2d");return this._drawCheckerboard(t,n.width,n.height),e.appendChild(n),e}_drawCheckerboard(e,n,t,a=0){if(!e)return;const i=this._getCheckerPattern(e),r=this._getCheckerboardScale(a);if(i&&"function"==typeof e.save&&"function"==typeof e.scale){e.save(),e.fillStyle=i;const a=n/2,l=t/2;return e.translate(a,l),e.scale(r,r),e.translate(-a,-l),e.fillRect(0,0,n,t),void e.restore()}const l=Math.max(2,Math.round(8*r));e.fillStyle="#333",e.fillRect(0,0,n,t),e.fillStyle="#444";for(let a=0;a<t;a+=l)for(let t=0;t<n;t+=l)(t/l+a/l)%2==0&&e.fillRect(t,a,l,l)}_getCheckerPattern(e){if(!e||!this._checkerPatternCanvas||"function"!=typeof e.createPattern)return null;if(this._checkerPatternCache&&this._checkerPatternCache.has(e))return this._checkerPatternCache.get(e);const n=e.createPattern(this._checkerPatternCanvas,"repeat");return n&&this._checkerPatternCache&&this._checkerPatternCache.set(e,n),n}_getCheckerboardScale(e=0){return 1+(2.2-1)*Math.max(0,Math.min(1,Number.isFinite(e)?e:0))}_selectLayer(e){this.selectedLayerId=e,document.querySelectorAll(".p5ml-layer-item").forEach(n=>{n.dataset.layerId==e?(n.classList.add("p5ml-selected"),n.style.background="#3a7bc8",n.style.borderLeft="3px solid #5dade2"):(n.classList.remove("p5ml-selected"),n.style.background="",n.style.borderLeft="")})}_deselectLayer(){this.selectedLayerId=null,document.querySelectorAll(".p5ml-layer-item").forEach(e=>{e.classList.remove("p5ml-selected"),e.style.background="",e.style.borderLeft=""})}_moveSelectedLayer(e){if(null===this.selectedLayerId)return;const n=this.layerSystem.getLayers(),t=n.findIndex(e=>e.id===this.selectedLayerId);if(-1===t)return;const a=t-e;if(a<0||a>=n.length)return;const i=n[a];[n[t],n[a]]=[n[a],n[t]];const r=this.layerElements.get(this.selectedLayerId),l=this.layerElements.get(i.id);if(r&&l&&this.layersContainer)if(-1===e)this.layersContainer.insertBefore(r,l);else{const e=l.nextSibling;this.layersContainer.insertBefore(r,e)}this._markThumbnailsDirty([this.selectedLayerId,i.id]),"function"==typeof this.layerSystem.reorderLayers&&this.layerSystem.reorderLayers(n),this._selectLayer(this.selectedLayerId)}_attachStyles(){if(document.getElementById("p5ml-layer-ui-styles"))return;const e=document.createElement("style");e.id="p5ml-layer-ui-styles",e.textContent="\n      .p5ml-layer-panel {\n        position: fixed;\n        background: rgba(26, 26, 26, 0.95);\n        border: 1px solid #444;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        font-size: 13px;\n        color: #e0e0e0;\n        z-index: 10000;\n        backdrop-filter: blur(10px);\n        overflow: hidden;\n      }\n\n      .p5ml-layer-panel.collapsed .p5ml-layers-container {\n        display: none;\n      }\n\n      .p5ml-panel-header {\n        background: rgba(60, 60, 60, 0.9);\n        padding: 12px 16px;\n        border-bottom: 1px solid #333;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        user-select: none;\n      }\n\n      .p5ml-panel-title {\n        font-weight: 600;\n        font-size: 16px;\n        letter-spacing: 0.5px;\n        color: #ccc;\n      }\n\n      .p5ml-header-controls {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .p5ml-arrow-btn {\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        border-radius: 4px;\n        color: #e8e8e8;\n        font-size: 16px;\n        cursor: pointer;\n        padding: 4px 8px;\n        width: 28px;\n        height: 28px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.15s;\n      }\n\n      .p5ml-arrow-btn:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.3);\n      }\n\n      .p5ml-arrow-btn:active {\n        background: rgba(255, 255, 255, 0.2);\n      }\n\n      .p5ml-collapse-btn {\n        background: none;\n        border: none;\n        color: #aaa;\n        font-size: 18px;\n        cursor: pointer;\n        padding: 0;\n        width: 20px;\n        height: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .p5ml-collapse-btn:hover {\n        color: #fff;\n      }\n\n      .p5ml-layers-container {\n        max-height: 500px;\n        overflow-y: auto;\n        padding: 0;\n        background: #2a2a2a;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.2);\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 4px;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      /* Procreate-style layer item */\n      .p5ml-layer-item {\n        background: transparent;\n        border-bottom: 1px solid #3a3a3a;\n        transition: background 0.15s ease;\n        cursor: pointer;\n      }\n\n      .p5ml-layer-item:hover {\n        background: rgba(100, 150, 255, 0.15);\n      }\n\n      /* Selected state */\n      .p5ml-layer-item.p5ml-selected {\n        background: #3a7bc8 !important;\n        border-left: 3px solid #5dade2;\n      }\n\n      .p5ml-layer-item.p5ml-selected:hover {\n        background: #4a8dd8 !important;\n      }\n\n      .p5ml-layer-item.p5ml-selected .p5ml-layer-row {\n        background: transparent;\n      }\n\n      /* Main layer row (horizontal layout) */\n      .p5ml-layer-row {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 10px 12px;\n      }\n\n      /* Thumbnail on the left */\n      .p5ml-layer-thumbnail {\n        flex-shrink: 0;\n      }\n\n      .p5ml-layer-thumbnail canvas {\n        display: block;\n        width: 60px;\n        height: 60px;\n        border: 1px solid #555;\n        border-radius: 4px;\n        image-rendering: pixelated;\n      }\n\n      /* Layer name in center */\n      .p5ml-layer-name {\n        flex: 1;\n        font-weight: 500;\n        font-size: 15px;\n        color: #e8e8e8;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      /* Right side controls */\n      .p5ml-right-controls {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        flex-shrink: 0;\n      }\n\n      /* Blend mode letter indicator */\n      .p5ml-blend-indicator {\n        width: 28px;\n        height: 28px;\n        border-radius: 4px;\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        color: #e8e8e8;\n        font-weight: 600;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.15s;\n        pointer-events: auto;\n      }\n\n      .p5ml-blend-indicator:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.3);\n      }\n\n      /* Visibility checkbox */\n      .p5ml-visibility-checkbox {\n        width: 20px;\n        height: 20px;\n        cursor: pointer;\n        accent-color: #4a90e2;\n        pointer-events: auto;\n      }\n\n      /* Dropdown panel for opacity and blend mode */\n      .p5ml-layer-dropdown {\n        background: rgba(40, 40, 40, 0.95);\n        border-top: 1px solid #555;\n        padding: 16px;\n        display: none;\n      }\n\n      .p5ml-control-group {\n        margin-bottom: 16px;\n      }\n\n      .p5ml-control-group:last-child {\n        margin-bottom: 0;\n      }\n\n      .p5ml-control-group label {\n        font-size: 11px;\n        color: #999;\n        text-transform: uppercase;\n        letter-spacing: 0.8px;\n        font-weight: 600;\n        display: flex;\n        justify-content: space-between;\n        margin-bottom: 8px;\n      }\n\n      .p5ml-opacity-value {\n        color: #e0e0e0;\n        font-weight: 600;\n      }\n\n      .p5ml-opacity-slider {\n        width: 100%;\n        height: 6px;\n        border-radius: 3px;\n        outline: none;\n        -webkit-appearance: none;\n        background: rgba(255, 255, 255, 0.15);\n        margin-top: 4px;\n      }\n\n      .p5ml-opacity-slider::-webkit-slider-thumb {\n        -webkit-appearance: none;\n        appearance: none;\n        width: 18px;\n        height: 18px;\n        border-radius: 50%;\n        background: #fff;\n        cursor: pointer;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .p5ml-opacity-slider::-moz-range-thumb {\n        width: 18px;\n        height: 18px;\n        border-radius: 50%;\n        background: #fff;\n        cursor: pointer;\n        border: none;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .p5ml-blend-select {\n        width: 100%;\n        background: rgba(0, 0, 0, 0.4);\n        border: 1px solid #555;\n        border-radius: 6px;\n        color: #e8e8e8;\n        padding: 10px 12px;\n        font-size: 14px;\n        cursor: pointer;\n        outline: none;\n        margin-top: 4px;\n      }\n\n      .p5ml-blend-select:hover {\n        border-color: #777;\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      .p5ml-blend-select option {\n        background: #2a2a2a;\n        color: #e8e8e8;\n        padding: 8px;\n      }\n\n      /* Hide old thumbnail styles - no longer used */\n      .p5ml-thumbnail-label {\n        display: none;\n      }\n    ",document.head.appendChild(e)}toggle(){this.isCollapsed=!this.isCollapsed,this.container.classList.toggle("collapsed",this.isCollapsed);const e=this.container.querySelector(".p5ml-collapse-btn");e&&(e.innerHTML=this.isCollapsed?"+":"−")}show(){this.container.style.display="block"}hide(){this.container.style.display="none"}dispose(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this._cancelThumbnailFlush&&null!==this._thumbnailFlushHandle&&this._cancelThumbnailFlush(this._thumbnailFlushHandle),this._dirtyThumbnailLayerIds.clear(),this._captureNeeded.clear(),this._thumbnailCache.clear(),this._thumbnailFlushHandle=null,this._cancelThumbnailFlush=null,this._thumbnailScratchCanvas=null,this._thumbnailScratchCtx=null}}class s{constructor(e){if(this.p=e,!this.p._renderer||!this.p._renderer.drawingContext)throw new Error("Canvas not initialized. Make sure createCanvas() is called before createLayerSystem()");if(!(this.p._renderer.drawingContext instanceof WebGLRenderingContext||this.p._renderer.drawingContext instanceof WebGL2RenderingContext))throw new Error("LayerSystem requires WebGL mode. Use createCanvas(w, h, WEBGL)");this.layers=new Map,this.layerNames=new Map,this.layerIdCounter=0,this.activeLayerId=null,this.compositor=new r(e),this.ui=null,this.autoResize=!0,this._lastCanvasWidth=this.p.width,this._lastCanvasHeight=this.p.height}_generateId(){return this.layerIdCounter++}_getLayerById(e){if("number"==typeof e)return this.layers.get(e)||null;if("string"==typeof e){const n=this.layerNames.get(e);if(void 0!==n)return this.layers.get(n)||null}return null}createLayer(e="",n={}){const t=this._generateId(),a=e||`Layer ${t}`,r=new i(this.p,t,a,{...n,zIndex:void 0!==n.zIndex?n.zIndex:t});return this.layers.set(t,r),a&&this.layerNames.set(a,t),r}removeLayer(e){const n=this._getLayerById(e);n?(this.activeLayerId===n.id&&this.end(),n.name&&this.layerNames.delete(n.name),n.dispose(),this.layers.delete(n.id)):console.warn(`Layer ${e} not found`)}getLayer(e){return this._getLayerById(e)}getLayers(){return Array.from(this.layers.values()).sort((e,n)=>e.zIndex-n.zIndex)}getLayerInfo(){return this.getLayers().map(e=>e.toJSON())}begin(e){null!==this.activeLayerId&&(console.warn(`Layer ${this.activeLayerId} is already active. Ending it first.`),this.end());const n=this._getLayerById(e);n?(n.begin(),this.activeLayerId=n.id):console.error(`Layer ${e} not found`)}end(){if(null===this.activeLayerId)return void console.warn("No active layer to end");const e=this.layers.get(this.activeLayerId);e&&(e.end(),this.ui&&"function"==typeof this.ui.scheduleThumbnailUpdate&&this.ui.scheduleThumbnailUpdate(e.id,{needsCapture:!0})),this.activeLayerId=null}show(e){const n=this._getLayerById(e);return n?n.show():(console.warn(`Layer ${e} not found`),null)}hide(e){const n=this._getLayerById(e);return n?n.hide():(console.warn(`Layer ${e} not found`),null)}setOpacity(e,n){const t=this._getLayerById(e);return t?t.setOpacity(n):(console.warn(`Layer ${e} not found`),null)}setBlendMode(e,n){const t=this._getLayerById(e);return t?t.setBlendMode(n):(console.warn(`Layer ${e} not found`),null)}setLayerIndex(e,n){const t=this._getLayerById(e);return t?t.setZIndex(n):(console.warn(`Layer ${e} not found`),null)}moveLayer(e,n){const t=this._getLayerById(e);return t?t.setZIndex(t.zIndex+n):(console.warn(`Layer ${e} not found`),null)}reorderLayers(e){e.forEach((e,n)=>{e.setZIndex(n)})}setMask(e,n){const t=this._getLayerById(e);return t?t.setMask(n):(console.warn(`Layer ${e} not found`),null)}clearMask(e){const n=this._getLayerById(e);return n?n.clearMask():(console.warn(`Layer ${e} not found`),null)}render(e=null){this.autoResize&&this._checkResize();const n=this.getLayers();this.compositor.render(n,e),this.ui&&this.ui.syncState()}_checkResize(){if(this.p.width!==this._lastCanvasWidth||this.p.height!==this._lastCanvasHeight){this._lastCanvasWidth=this.p.width,this._lastCanvasHeight=this.p.height;for(const e of this.layers.values())e.customSize||e.resize(this.p.width,this.p.height)}}setAutoResize(e){this.autoResize=!!e}createUI(e={}){return this.ui&&this.ui.dispose(),this.ui=new l(this,e),this.ui.update(),this.ui}updateUI(){this.ui&&this.ui.update()}dispose(){null!==this.activeLayerId&&this.end(),this.ui&&(this.ui.dispose(),this.ui=null);for(const e of this.layers.values())e.dispose();this.layers.clear(),this.compositor.dispose()}}function o(e,n,t){n.createLayerSystem=function(e={}){return new s(this,e)},t&&(t.remove=function(){this._layerSystem&&(this._layerSystem.dispose(),this._layerSystem=null)})}"undefined"!=typeof window&&void 0!==window.p5&&(window.p5.registerAddon(o),window.BlendModes=n),e.BlendModes=n,e.Compositor=r,e.DEFAULT_LAYER_OPTIONS=a,e.Layer=i,e.LayerSystem=s,e.LayerUI=l,e.VERSION="0.1.0",e.default=o,e.getBlendModeIndex=t,Object.defineProperty(e,"__esModule",{value:!0})});