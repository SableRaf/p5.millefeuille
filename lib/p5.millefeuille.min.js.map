{"version":3,"file":"p5.millefeuille.min.js","sources":["../src/constants.js","../src/Layer.js","../src/Compositor.js","../src/utils/alphaBounds.js","../src/LayerUI.js","../src/LayerSystem.js","../src/index.js"],"sourcesContent":["/**\n * Blend mode constants for layer compositing\n * These map to glsl-blend functions in the compositor shader\n */\nexport const BlendModes = {\n  NORMAL: 'NORMAL',\n  MULTIPLY: 'MULTIPLY',\n  SCREEN: 'SCREEN',\n  ADD: 'ADD',\n  SUBTRACT: 'SUBTRACT',\n  OVERLAY: 'OVERLAY',\n  SOFT_LIGHT: 'SOFT_LIGHT',\n  HARD_LIGHT: 'HARD_LIGHT',\n  COLOR_DODGE: 'COLOR_DODGE',\n  COLOR_BURN: 'COLOR_BURN',\n  DARKEN: 'DARKEN',\n  LIGHTEN: 'LIGHTEN',\n  DIFFERENCE: 'DIFFERENCE',\n  EXCLUSION: 'EXCLUSION'\n};\n\n/**\n * Maps our blend modes to shader uniform integers\n * These correspond to the blend mode indices in compositor.frag\n */\nexport function getBlendModeIndex(mode) {\n  switch (mode) {\n    case BlendModes.NORMAL:\n      return 0;\n    case BlendModes.MULTIPLY:\n      return 1;\n    case BlendModes.SCREEN:\n      return 2;\n    case BlendModes.ADD:\n      return 3;\n    case BlendModes.SUBTRACT:\n      return 4;\n    case BlendModes.OVERLAY:\n      return 5;\n    case BlendModes.SOFT_LIGHT:\n      return 6;\n    case BlendModes.HARD_LIGHT:\n      return 7;\n    case BlendModes.COLOR_DODGE:\n      return 8;\n    case BlendModes.COLOR_BURN:\n      return 9;\n    case BlendModes.DARKEN:\n      return 10;\n    case BlendModes.LIGHTEN:\n      return 11;\n    case BlendModes.DIFFERENCE:\n      return 12;\n    case BlendModes.EXCLUSION:\n      return 13;\n    default:\n      console.warn(`Unknown blend mode: ${mode}, falling back to NORMAL`);\n      return 0;\n  }\n}\n\n/**\n * Default layer options\n */\nexport const DEFAULT_LAYER_OPTIONS = {\n  visible: true,\n  opacity: 1.0,\n  blendMode: BlendModes.NORMAL,\n  width: null,  // null means use canvas width\n  height: null, // null means use canvas height\n  density: null, // null means use canvas density\n  depth: false,\n  antialias: false\n};\n","import { BlendModes, DEFAULT_LAYER_OPTIONS } from './constants.js';\n\n/**\n * Represents a single layer backed by a p5.Framebuffer\n */\nexport class Layer {\n  /**\n   * @param {p5} p5Instance - The p5.js instance\n   * @param {string|number} id - Unique identifier for this layer\n   * @param {string} name - Human-readable name for this layer\n   * @param {Object} options - Layer configuration options\n   */\n  constructor(p5Instance, id, name = '', options = {}) {\n    this.p = p5Instance;\n    this.id = id;\n    this.name = name || `Layer ${id}`;\n\n    // Merge with defaults\n    const opts = { ...DEFAULT_LAYER_OPTIONS, ...options };\n\n    this.visible = opts.visible;\n    this.opacity = this._clampOpacity(opts.opacity);\n    this.blendMode = opts.blendMode;\n    this.zIndex = opts.zIndex !== undefined ? opts.zIndex : id;\n\n    // Framebuffer options\n    this.width = opts.width ?? this.p.width;\n    this.height = opts.height ?? this.p.height;\n    this.density = opts.density ?? this.p.pixelDensity();\n    this.depth = opts.depth;\n    this.antialias = opts.antialias;\n\n    // Flag layers that opted into custom sizing to protect them from auto-resize\n    this.customSize = opts.width != null ||\n      opts.height != null ||\n      opts.density != null;\n\n    // Mask reference (can be p5.Framebuffer or p5.Image)\n    this.mask = null;\n\n    // Track if layer has been drawn to at least once\n    this.hasBeenDrawnTo = false;\n\n    // Create the framebuffer\n    this.framebuffer = this._createFramebuffer();\n\n    if (!this.framebuffer) {\n      throw new Error(`Failed to create framebuffer for layer ${this.name}`);\n    }\n  }\n\n  /**\n   * Creates the underlying p5.Framebuffer\n   * @private\n   */\n  _createFramebuffer() {\n    try {\n      const options = {\n        width: this.width,\n        height: this.height,\n        density: this.density\n      };\n\n      // Only add depth and antialias if explicitly set\n      if (this.depth !== undefined) {\n        options.depth = this.depth;\n      }\n      if (this.antialias !== undefined) {\n        options.antialias = this.antialias;\n      }\n\n      return this.p.createFramebuffer(options);\n    } catch (e) {\n      console.error(`Error creating framebuffer for layer ${this.name}:`, e);\n      return null;\n    }\n  }\n\n  /**\n   * Clamps opacity value to valid range [0, 1]\n   * @private\n   */\n  _clampOpacity(value) {\n    return Math.max(0, Math.min(1, value));\n  }\n\n  /**\n   * Shows this layer (makes it visible)\n   * @returns {Layer} This layer for chaining\n   */\n  show() {\n    this.visible = true;\n    return this;\n  }\n\n  /**\n   * Hides this layer (makes it invisible)\n   * @returns {Layer} This layer for chaining\n   */\n  hide() {\n    this.visible = false;\n    return this;\n  }\n\n  /**\n   * Sets the opacity of this layer\n   * @param {number} opacity - Opacity value between 0 and 1\n   * @returns {Layer} This layer for chaining\n   */\n  setOpacity(opacity) {\n    this.opacity = this._clampOpacity(opacity);\n    return this;\n  }\n\n  /**\n   * Sets the blend mode for this layer\n   * @param {string} mode - One of the BlendModes constants\n   * @returns {Layer} This layer for chaining\n   */\n  setBlendMode(mode) {\n    if (!Object.values(BlendModes).includes(mode)) {\n      console.warn(`Invalid blend mode: ${mode}, using NORMAL`);\n      this.blendMode = BlendModes.NORMAL;\n    } else {\n      this.blendMode = mode;\n    }\n    return this;\n  }\n\n  /**\n   * Sets the z-index (layer order) for this layer\n   * @param {number} zIndex - The z-index value (higher = on top)\n   * @returns {Layer} This layer for chaining\n   */\n  setZIndex(zIndex) {\n    this.zIndex = zIndex;\n    return this;\n  }\n\n  /**\n   * Attaches a mask to this layer\n   * @param {p5.Framebuffer|p5.Image} maskSource - The mask to apply\n   * @returns {Layer} This layer for chaining\n   */\n  setMask(maskSource) {\n    if (!maskSource) {\n      console.warn('Invalid mask source provided');\n      return this;\n    }\n    this.mask = maskSource;\n    return this;\n  }\n\n  /**\n   * Removes the mask from this layer\n   * @returns {Layer} This layer for chaining\n   */\n  clearMask() {\n    this.mask = null;\n    return this;\n  }\n\n  /**\n   * Resizes the layer's framebuffer\n   * @param {number} width - New width\n   * @param {number} height - New height\n   */\n  resize(width, height, density = this.density) {\n    this.width = width;\n    this.height = height;\n    this.density = density;\n\n    // Keep track of whether the layer is canvas-synced or intentionally customized\n    const matchesCanvas = width === this.p.width &&\n      height === this.p.height &&\n      density === this.p.pixelDensity();\n    this.customSize = !matchesCanvas;\n\n    // Dispose old framebuffer\n    if (this.framebuffer) {\n      this.framebuffer.remove();\n    }\n\n    // Create new framebuffer with updated size\n    this.framebuffer = this._createFramebuffer();\n  }\n\n  /**\n   * Begins drawing to this layer's framebuffer\n   */\n  begin() {\n    if (!this.framebuffer) {\n      console.error(`Cannot begin drawing: framebuffer not initialized for layer ${this.name}`);\n      return;\n    }\n    this.framebuffer.begin();\n  }\n\n  /**\n   * Ends drawing to this layer's framebuffer\n   */\n  end() {\n    if (!this.framebuffer) {\n      console.error(`Cannot end drawing: framebuffer not initialized for layer ${this.name}`);\n      return;\n    }\n    this.framebuffer.end();\n    \n    // Mark that this layer has been drawn to\n    this.hasBeenDrawnTo = true;\n  }\n\n  /**\n   * Disposes of this layer's resources\n   */\n  dispose() {\n    if (this.framebuffer) {\n      this.framebuffer.remove();\n      this.framebuffer = null;\n    }\n  }\n\n  /**\n   * Returns a plain object representation of this layer's properties\n   */\n  toJSON() {\n    return {\n      id: this.id,\n      name: this.name,\n      visible: this.visible,\n      opacity: this.opacity,\n      blendMode: this.blendMode,\n      zIndex: this.zIndex,\n      hasMask: !!this.mask,\n      hasBeenDrawnTo: this.hasBeenDrawnTo,\n      width: this.width,\n      height: this.height,\n      density: this.density,\n      customSize: this.customSize\n    };\n  }\n}\n","import { getBlendModeIndex } from './constants.js';\nimport compositorVertSource from './shaders/compositor.vert';\nimport compositorFragSource from './shaders/compositor.frag';\n\n/**\n * Handles the compositing of layers to the main canvas\n */\nexport class Compositor {\n  /**\n   * @param {p5} p5Instance - The p5.js instance\n   */\n  constructor(p5Instance) {\n    this.p = p5Instance;\n    this.shader = null;\n    this.shaderLoaded = false;\n    this.bufferA = null;\n    this.bufferB = null;\n    this._bufferDensity = null;\n  }\n\n  /**\n   * Lazily creates the compositor shader\n   * @private\n   */\n  _ensureShader() {\n    if (!this.shaderLoaded) {\n      try {\n        this.shader = this.p.createShader(compositorVertSource, compositorFragSource);\n        this.shaderLoaded = true;\n      } catch (e) {\n        console.error('Failed to create compositor shader:', e);\n        this.shaderLoaded = false;\n      }\n    }\n    return this.shader;\n  }\n\n  /**\n   * Ensures the ping-pong buffers exist and match canvas size\n   * @private\n   */\n  _ensureBuffers() {\n    const p = this.p;\n    \n    const currentDensity = p.pixelDensity();\n    const needsResize = !this.bufferA || \n              this.bufferA.width !== p.width || \n              this.bufferA.height !== p.height ||\n              this._bufferDensity !== currentDensity;\n    \n    if (needsResize) {\n      if (this.bufferA) {\n        this.bufferA.remove();\n        this.bufferB.remove();\n      }\n      \n      const bufferOptions = {\n        width: p.width,\n        height: p.height,\n        density: currentDensity,\n        antialias: false,\n        depth: false\n      };\n      \n      this.bufferA = p.createFramebuffer(bufferOptions);\n      this.bufferB = p.createFramebuffer(bufferOptions);\n      this._bufferDensity = currentDensity;\n    }\n    \n    return { a: this.bufferA, b: this.bufferB };\n  }\n\n  /**\n   * Renders a single layer to the current framebuffer\n   * @param {Layer} layer - The layer to render\n   * @param {p5.Framebuffer} backgroundBuffer - The background to composite onto\n   * @private\n   */\n  _renderLayer(layer, backgroundBuffer) {\n    if (!layer.visible || layer.opacity <= 0) {\n      return;\n    }\n\n    if (!layer.framebuffer) {\n      console.warn(`Layer ${layer.name} has no framebuffer, skipping`);\n      return;\n    }\n\n    const shader = this._ensureShader();\n    if (!shader) {\n      console.warn('Compositor shader not available, skipping layer');\n      return;\n    }\n\n    const p = this.p;\n\n    // Save current state\n    p.push();\n\n    // Use normal blending since we're doing the blend in the shader\n    p.blendMode(p.BLEND);\n\n    // Use the compositor shader\n    p.shader(shader);\n\n    // Set uniforms\n    shader.setUniform('layerTexture', layer.framebuffer);\n    shader.setUniform('backgroundTexture', backgroundBuffer);\n    shader.setUniform('maskTexture', layer.mask || layer.framebuffer);\n    shader.setUniform('hasMask', layer.mask ? true : false);\n    shader.setUniform('layerOpacity', layer.opacity);\n    shader.setUniform('blendMode', getBlendModeIndex(layer.blendMode));\n\n    // Draw a full-screen quad\n    p.imageMode(p.CENTER);\n    p.rectMode(p.CENTER);\n    p.noStroke();\n    p.fill(255);\n    p.rect(0, 0, p.width, p.height);\n\n    // Reset shader\n    p.resetShader();\n\n    // Restore state\n    p.pop();\n  }\n\n  /**\n   * Composites all layers to the main canvas using ping-pong buffering\n   * @param {Layer[]} layers - Array of layers to composite (should be pre-sorted by zIndex)\n   * @param {Function} clearCallback - Optional callback to clear the canvas before compositing\n   */\n  render(layers, clearCallback = null) {\n    const p = this.p;\n\n    // Ensure we have ping-pong buffers\n    const buffers = this._ensureBuffers();\n    let currentBuffer = buffers.a;\n    let nextBuffer = buffers.b;\n\n    // Sort layers by zIndex (ascending)\n    const sortedLayers = [...layers].sort((a, b) => a.zIndex - b.zIndex);\n\n    // Clear the first buffer\n    currentBuffer.begin();\n    p.clear();\n    currentBuffer.end();\n\n    // Render each layer progressively, ping-ponging between buffers\n    for (let i = 0; i < sortedLayers.length; i++) {\n      const layer = sortedLayers[i];\n      \n      if (!layer.visible || layer.opacity <= 0) {\n        continue;\n      }\n\n      // Render this layer on top of currentBuffer into nextBuffer\n      nextBuffer.begin();\n      p.clear();\n      this._renderLayer(layer, currentBuffer);\n      nextBuffer.end();\n\n      // Swap buffers\n      const temp = currentBuffer;\n      currentBuffer = nextBuffer;\n      nextBuffer = temp;\n    }\n\n    // Now render the final result to the main canvas\n    p.push();\n\n    // Clear the canvas if callback provided\n    if (clearCallback) {\n      clearCallback();\n    } else {\n      p.clear();\n    }\n\n    // Reset to default state\n    p.resetShader();\n    p.blendMode(p.BLEND);\n\n    // Draw the accumulated result to the main canvas\n    p.imageMode(p.CENTER);\n    p.image(currentBuffer, 0, 0);\n\n    p.pop();\n  }\n\n  /**\n   * Disposes of compositor resources\n   */\n  dispose() {\n    // Clean up ping-pong buffers\n    if (this.bufferA) {\n      this.bufferA.remove();\n      this.bufferA = null;\n    }\n    if (this.bufferB) {\n      this.bufferB.remove();\n      this.bufferB = null;\n    }\n    this._bufferDensity = null;\n    \n    // p5.js doesn't have explicit shader disposal, but we can clear the reference\n    this.shader = null;\n    this.shaderLoaded = false;\n  }\n}\n","/**\n * Computes the tightest bounds that contain all pixels whose alpha exceeds the given threshold.\n * @param {Uint8ClampedArray} pixels - RGBA pixel data.\n * @param {number} width - Image width in pixels.\n * @param {number} height - Image height in pixels.\n * @param {Object} [options]\n * @param {number} [options.alphaThreshold=8] - Minimum alpha required to treat a pixel as visible.\n * @param {number} [options.stride=1] - Number of pixels to skip per step when scanning.\n * @returns {{x:number,y:number,width:number,height:number}|null}\n */\nexport function computeAlphaBounds(pixels, width, height, options = {}) {\n  const threshold = Number.isFinite(options.alphaThreshold) ? options.alphaThreshold : 8;\n  const stride = Number.isFinite(options.stride) && options.stride > 0 ? Math.floor(options.stride) : 1;\n\n  let minX = width;\n  let minY = height;\n  let maxX = -1;\n  let maxY = -1;\n\n  for (let y = 0; y < height; y += stride) {\n    const rowOffset = y * width * 4;\n    for (let x = 0; x < width; x += stride) {\n      const idx = rowOffset + x * 4;\n      if (pixels[idx + 3] > threshold) {\n        if (x < minX) minX = x;\n        if (y < minY) minY = y;\n        if (x > maxX) maxX = x;\n        if (y > maxY) maxY = y;\n      }\n    }\n  }\n\n  if (maxX === -1 || maxY === -1) {\n    return null;\n  }\n\n  return {\n    x: minX,\n    y: minY,\n    width: maxX - minX + 1,\n    height: maxY - minY + 1\n  };\n}\n\n/**\n * Merges multiple bounds objects into their combined extents.\n * @param {Array<{x:number,y:number,width:number,height:number}|null>} boundsList\n * @returns {{x:number,y:number,width:number,height:number}|null}\n */\nexport function mergeBounds(boundsList) {\n  if (!Array.isArray(boundsList) || boundsList.length === 0) {\n    return null;\n  }\n\n  let minX = Number.POSITIVE_INFINITY;\n  let minY = Number.POSITIVE_INFINITY;\n  let maxX = Number.NEGATIVE_INFINITY;\n  let maxY = Number.NEGATIVE_INFINITY;\n  let found = false;\n\n  for (const bounds of boundsList) {\n    if (!bounds) {\n      continue;\n    }\n    found = true;\n    if (bounds.x < minX) minX = bounds.x;\n    if (bounds.y < minY) minY = bounds.y;\n    if (bounds.x + bounds.width > maxX) maxX = bounds.x + bounds.width;\n    if (bounds.y + bounds.height > maxY) maxY = bounds.y + bounds.height;\n  }\n\n  if (!found) {\n    return null;\n  }\n\n  return {\n    x: minX,\n    y: minY,\n    width: Math.max(0, maxX - minX),\n    height: Math.max(0, maxY - minY)\n  };\n}\n\n/**\n * Ensures bounds stay inside the provided limits.\n * @param {{x:number,y:number,width:number,height:number}|null} bounds\n * @param {number} maxWidth\n * @param {number} maxHeight\n * @returns {{x:number,y:number,width:number,height:number}|null}\n */\nexport function clampBounds(bounds, maxWidth, maxHeight) {\n  if (!bounds) {\n    return null;\n  }\n\n  const x = Math.max(0, Math.min(bounds.x, maxWidth));\n  const y = Math.max(0, Math.min(bounds.y, maxHeight));\n  const width = Math.max(0, Math.min(bounds.width, maxWidth - x));\n  const height = Math.max(0, Math.min(bounds.height, maxHeight - y));\n\n  return { x, y, width, height };\n}\n\n/**\n * Expands bounds by padding while clamping to limits.\n * @param {{x:number,y:number,width:number,height:number}|null} bounds\n * @param {number} padding\n * @param {number} maxWidth\n * @param {number} maxHeight\n * @returns {{x:number,y:number,width:number,height:number}|null}\n */\nexport function padBounds(bounds, padding, maxWidth, maxHeight) {\n  if (!bounds) {\n    return null;\n  }\n  const padded = {\n    x: bounds.x - padding,\n    y: bounds.y - padding,\n    width: bounds.width + padding * 2,\n    height: bounds.height + padding * 2\n  };\n  return clampBounds(padded, maxWidth, maxHeight);\n}\n","import { BlendModes } from './constants.js';\nimport { computeAlphaBounds, mergeBounds, padBounds } from './utils/alphaBounds.js';\n\n/**\n * LayerUI - A visual panel for displaying and controlling layers\n */\nexport class LayerUI {\n  /**\n   * @param {LayerSystem} layerSystem - The layer system to display\n   * @param {Object} options - UI configuration options\n   */\n  constructor(layerSystem, options = {}) {\n    this.layerSystem = layerSystem;\n    this.options = {\n      ...options,\n      position: options.position || 'top-right',\n      width: options.width || 280,\n      collapsible: options.collapsible !== false,\n      draggable: options.draggable !== false,\n      thumbnailPadding: options.thumbnailPadding ?? 4,\n      thumbnailSampleMaxSize: options.thumbnailSampleMaxSize ?? 196,\n      thumbnailAlphaThreshold: options.thumbnailAlphaThreshold ?? 12,\n      thumbnailAnimationWindow: options.thumbnailAnimationWindow ?? 6,\n      thumbnailEmptyFrameReset: options.thumbnailEmptyFrameReset ?? 6,\n      thumbnailSampleStride: options.thumbnailSampleStride ?? 1,\n      thumbnailAutoUpdate: options.thumbnailAutoUpdate === true,\n      thumbnailUpdateEvery: options.thumbnailUpdateEvery ?? 0\n    };\n\n    // Warn if thumbnailUpdateEvery is set but thumbnailAutoUpdate is false\n    if (options.thumbnailUpdateEvery !== undefined && options.thumbnailUpdateEvery > 0 && !this.options.thumbnailAutoUpdate) {\n      console.warn('p5.millefeuille: thumbnailUpdateEvery is set but thumbnailAutoUpdate is false. thumbnailUpdateEvery will be ignored. Set thumbnailAutoUpdate: true to enable automatic thumbnail updates.');\n    }\n\n    this.isCollapsed = false;\n    this.container = null;\n    this.layerElements = new Map(); // layerId -> DOM element\n    this.selectedLayerId = null; // Currently selected layer\n    this._dirtyThumbnailLayerIds = new Set();\n    this._captureNeeded = new Set();\n    this._thumbnailCache = new Map(); // layerId -> { image }\n    this._thumbnailFlushHandle = null;\n    this._cancelThumbnailFlush = null;\n    this._thumbnailBatchSize = 1;\n    this._thumbnailIdleBudgetMs = 8;\n    this._thumbnailScratchCanvas = typeof document !== 'undefined' ? document.createElement('canvas') : null;\n    this._thumbnailScratchCtx = this._thumbnailScratchCanvas ? this._thumbnailScratchCanvas.getContext('2d') : null;\n    if (this._thumbnailScratchCtx) {\n      this._thumbnailScratchCtx.imageSmoothingEnabled = false;\n    }\n    // Lazy-initialized WEBGL buffer for GPU-to-GPU downsampling\n    this._downsampleBuffer = null;\n\n    this._checkerPatternCanvas = typeof document !== 'undefined' ? document.createElement('canvas') : null;\n    this._checkerPatternCache = typeof WeakMap !== 'undefined' ? new WeakMap() : null;\n    if (this._checkerPatternCanvas) {\n      const size = 8;\n      this._checkerPatternCanvas.width = size;\n      this._checkerPatternCanvas.height = size;\n      const checkerCtx = this._checkerPatternCanvas.getContext('2d');\n      if (checkerCtx) {\n        checkerCtx.fillStyle = '#333';\n        checkerCtx.fillRect(0, 0, size, size);\n        checkerCtx.fillStyle = '#444';\n        checkerCtx.fillRect(0, 0, size / 2, size / 2);\n        checkerCtx.fillRect(size / 2, size / 2, size / 2, size / 2);\n      }\n    }\n\n    this._createUI();\n    this._attachStyles();\n  }\n\n  /**\n   * Creates the DOM structure for the UI panel\n   * @private\n   */\n  _createUI() {\n    // Create main container\n    this.container = document.createElement('div');\n    this.container.className = 'p5ml-layer-panel';\n    this.container.style.width = `${this.options.width}px`;\n\n    // Create header\n    const header = document.createElement('div');\n    header.className = 'p5ml-panel-header';\n    header.innerHTML = `\n      <span class=\"p5ml-panel-title\">Layers</span>\n      <div class=\"p5ml-header-controls\">\n        <button class=\"p5ml-arrow-btn p5ml-arrow-up\" title=\"Move layer up\">↑</button>\n        <button class=\"p5ml-arrow-btn p5ml-arrow-down\" title=\"Move layer down\">↓</button>\n        ${this.options.collapsible ? '<button class=\"p5ml-collapse-btn\">−</button>' : ''}\n      </div>\n    `;\n    this.container.appendChild(header);\n\n    // Create layers container\n    this.layersContainer = document.createElement('div');\n    this.layersContainer.className = 'p5ml-layers-container';\n    this.container.appendChild(this.layersContainer);\n\n    // Add to document\n    document.body.appendChild(this.container);\n\n    // Position the panel\n    this._positionPanel();\n\n    // Get cleanup signal for event listeners\n    const signal = this.layerSystem.p._removeSignal;\n\n    // Add event listeners\n    if (this.options.collapsible) {\n      const collapseBtn = header.querySelector('.p5ml-collapse-btn');\n      collapseBtn.addEventListener('click', () => this.toggle(), { signal });\n      // Prevent collapse button from triggering drag\n      collapseBtn.addEventListener('mousedown', (e) => e.stopPropagation(), { signal });\n    }\n\n    // Arrow button handlers\n    const upBtn = header.querySelector('.p5ml-arrow-up');\n    const downBtn = header.querySelector('.p5ml-arrow-down');\n    upBtn.addEventListener('click', () => this._moveSelectedLayer(-1), { signal });\n    downBtn.addEventListener('click', () => this._moveSelectedLayer(1), { signal });\n    // Prevent arrow buttons from triggering drag\n    upBtn.addEventListener('mousedown', (e) => e.stopPropagation(), { signal });\n    downBtn.addEventListener('mousedown', (e) => e.stopPropagation(), { signal });\n\n    // Make draggable if enabled\n    if (this.options.draggable) {\n      this._makeDraggable(header);\n    }\n\n    // Close dropdowns and deselect when clicking outside\n    document.addEventListener('click', (e) => {\n      // Check if click is outside the layer panel\n      if (!this.container.contains(e.target)) {\n        this._closeAllDropdowns();\n        this._deselectLayer();\n      }\n    }, { signal });\n\n    // Keyboard navigation for arrow keys\n    document.addEventListener('keydown', (e) => {\n      if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') {\n        return;\n      }\n\n      if (e.repeat || this.selectedLayerId === null) {\n        return;\n      }\n\n      if (!this._isPanelVisible()) {\n        return;\n      }\n\n      // Don't interfere if user is typing in an input field\n      if (e.target.matches('input, select, textarea')) {\n        return;\n      }\n\n      e.preventDefault();\n\n      this._moveSelectedLayer(e.key === 'ArrowUp' ? -1 : 1);\n    }, { signal });\n  }\n\n  /**\n   * Closes all open layer dropdowns\n   * @private\n   */\n  _closeAllDropdowns() {\n    document.querySelectorAll('.p5ml-layer-dropdown').forEach(d => {\n      d.style.display = 'none';\n    });\n  }\n\n  /**\n   * Positions the panel based on options\n   * @private\n   */\n  _positionPanel() {\n    const positions = {\n      'top-right': { top: '20px', right: '20px' },\n      'top-left': { top: '20px', left: '20px' },\n      'bottom-right': { bottom: '20px', right: '20px' },\n      'bottom-left': { bottom: '20px', left: '20px' }\n    };\n\n    const pos = positions[this.options.position] || positions['top-right'];\n    Object.assign(this.container.style, pos);\n  }\n\n  /**\n   * Determines if the panel is currently visible on screen\n   * @private\n   */\n  _isPanelVisible() {\n    if (!this.container || this.container.style.display === 'none') {\n      return false;\n    }\n    return this.container.getClientRects().length > 0;\n  }\n\n  /**\n   * Makes the panel draggable\n   * @private\n   */\n  _makeDraggable(header) {\n    let isDragging = false;\n    let offsetX;\n    let offsetY;\n\n    header.style.cursor = 'move';\n\n    const signal = this.layerSystem.p._removeSignal;\n\n    header.addEventListener('mousedown', (e) => {\n      // Get current position using getBoundingClientRect for accuracy\n      const rect = this.container.getBoundingClientRect();\n      \n      // Calculate offset from mouse to panel's top-left corner\n      offsetX = e.clientX - rect.left;\n      offsetY = e.clientY - rect.top;\n      \n      isDragging = true;\n\n      // Clear all positioning properties and switch to left/top only\n      this.container.style.right = '';\n      this.container.style.bottom = '';\n      this.container.style.left = rect.left + 'px';\n      this.container.style.top = rect.top + 'px';\n    });\n\n    document.addEventListener('mousemove', (e) => {\n      if (isDragging) {\n        e.preventDefault();\n        \n        // Calculate new position\n        let newX = e.clientX - offsetX;\n        let newY = e.clientY - offsetY;\n\n        // Get panel dimensions\n        const panelWidth = this.container.offsetWidth;\n        \n        // Get viewport dimensions\n        const viewportWidth = window.innerWidth;\n        const viewportHeight = window.innerHeight;\n        \n        // Constrain position to keep panel visible (with minimum 50px visible)\n        const minVisible = 50;\n        newX = Math.max(-panelWidth + minVisible, Math.min(newX, viewportWidth - minVisible));\n        newY = Math.max(0, Math.min(newY, viewportHeight - minVisible));\n\n        this.container.style.left = newX + 'px';\n        this.container.style.top = newY + 'px';\n      }\n    }, { signal });\n\n    document.addEventListener('mouseup', () => {\n      isDragging = false;\n    }, { signal });\n  }\n\n  /**\n   * Updates the UI to reflect current layer state\n   */\n  update() {\n    const layers = this.layerSystem.getLayers();\n\n    this._pruneThumbnailState(layers);\n\n    // Clear existing layer elements\n    this.layersContainer.innerHTML = '';\n    this.layerElements.clear();\n\n    // Create elements for each layer (reverse order so top layers appear first)\n    const reversedLayers = [...layers].reverse();\n\n    reversedLayers.forEach(layer => {\n      const layerEl = this._createLayerElement(layer);\n      this.layersContainer.appendChild(layerEl);\n      this.layerElements.set(layer.id, layerEl);\n    });\n\n    // Initial thumbnail render is scheduled lazily to avoid blocking\n    this._markThumbnailsDirty(reversedLayers.map(layer => layer.id), { needsCapture: true });\n  }\n\n  /**\n   * Public helper so the LayerSystem can schedule updates when layer content changes\n   * @param {number|string} layerId\n   * @param {{needsCapture?: boolean}} options\n   */\n  scheduleThumbnailUpdate(layerId, options = {}) {\n    this._markThumbnailsDirty([layerId], options);\n  }\n\n  /**\n   * Synchronizes UI controls with current layer state without recreating elements\n   */\n  syncState() {\n    const layers = this.layerSystem.getLayers();\n\n    layers.forEach(layer => {\n      const layerEl = this.layerElements.get(layer.id);\n      if (!layerEl) return;\n\n      // Update checkbox\n      const checkbox = layerEl.querySelector('.p5ml-visibility-checkbox');\n      if (checkbox) {\n        checkbox.checked = layer.visible;\n      }\n\n      // Update opacity slider and value\n      const opacitySlider = layerEl.querySelector('.p5ml-opacity-slider');\n      const opacityValue = layerEl.querySelector('.p5ml-opacity-value');\n      if (opacitySlider && opacityValue) {\n        const opacityPercent = Math.round(layer.opacity * 100);\n        opacitySlider.value = opacityPercent;\n        opacityValue.textContent = opacityPercent + '%';\n      }\n\n      // Update blend mode select and indicator\n      const blendSelect = layerEl.querySelector('.p5ml-blend-select');\n      const blendIndicator = layerEl.querySelector('.p5ml-blend-indicator');\n      if (blendSelect) {\n        blendSelect.value = layer.blendMode;\n      }\n      if (blendIndicator) {\n        blendIndicator.textContent = this._getBlendModeLetter(layer.blendMode);\n        blendIndicator.title = `Blend Mode: ${layer.blendMode}`;\n      }\n    });\n\n    // Thumbnails are only updated when clicked (not automatically)\n  }\n\n  /**\n   * Updates all thumbnails\n   * @private\n   */\n  _markThumbnailsDirty(layerIds = [], options = {}) {\n    const ids = Array.isArray(layerIds) ? layerIds : [layerIds];\n    const needsCapture = !!options.needsCapture;\n    let shouldSchedule = false;\n\n    // Determine if this frame should trigger an update based on settings\n    // If thumbnailAutoUpdate is false, no automatic updates (thumbnailUpdateEvery is ignored)\n    // If thumbnailAutoUpdate is true and thumbnailUpdateEvery is not set (0), update every frame\n    // If thumbnailAutoUpdate is true and thumbnailUpdateEvery > 0, update every N frames\n    let isUpdateFrame = false;\n    if (this.options.thumbnailAutoUpdate && needsCapture) {\n      const updateEvery = this.options.thumbnailUpdateEvery;\n      if (updateEvery <= 0) {\n        // Default to every frame when thumbnailAutoUpdate is true but thumbnailUpdateEvery not set\n        isUpdateFrame = true;\n      } else {\n        // Use p5's frameCount to determine update frames consistently across all layers\n        const frameCount = this.layerSystem.p.frameCount || 0;\n        isUpdateFrame = frameCount % updateEvery === 0;\n      }\n    }\n\n    ids.forEach(id => {\n      if (id === null || id === undefined) {\n        return;\n      }\n\n      const cacheEntry = this._thumbnailCache.get(id);\n      const hasThumbnail = !!(cacheEntry && cacheEntry.image);\n\n      // Without auto updates, skip automatic updates for existing thumbnails.\n      // Thumbnails will only update when user clicks the layer row.\n      if (!isUpdateFrame && hasThumbnail && needsCapture) {\n        return;\n      }\n\n      this._dirtyThumbnailLayerIds.add(id);\n      if (needsCapture) {\n        this._captureNeeded.add(id);\n      }\n\n      // Schedule flush if auto updates enabled, or if first capture needed\n      if (isUpdateFrame || (!hasThumbnail && needsCapture)) {\n        shouldSchedule = true;\n      }\n    });\n\n    if (!shouldSchedule) {\n      return;\n    }\n    this._scheduleThumbnailFlush();\n  }\n\n  /**\n   * Removes cached thumbnail data for layers that no longer exist\n   * @private\n   */\n  _pruneThumbnailState(activeLayers) {\n    const liveIds = new Set(activeLayers.map(layer => layer.id));\n\n    for (const id of Array.from(this._thumbnailCache.keys())) {\n      if (!liveIds.has(id)) {\n        this._thumbnailCache.delete(id);\n      }\n    }\n\n    for (const id of Array.from(this._captureNeeded)) {\n      if (!liveIds.has(id)) {\n        this._captureNeeded.delete(id);\n      }\n    }\n\n    for (const id of Array.from(this._dirtyThumbnailLayerIds)) {\n      if (!liveIds.has(id)) {\n        this._dirtyThumbnailLayerIds.delete(id);\n      }\n    }\n  }\n\n  /**\n   * Processes a small batch of dirty thumbnails on each animation frame\n   * @private\n   */\n  _flushDirtyThumbnails(deadline) {\n    if (this._dirtyThumbnailLayerIds.size === 0) {\n      return;\n    }\n\n    const hasPerformanceNow = typeof performance !== 'undefined' && typeof performance.now === 'function';\n    const start = hasPerformanceNow ? performance.now() : null;\n\n    const timeRemaining = (deadline && typeof deadline.timeRemaining === 'function')\n      ? () => deadline.timeRemaining()\n      : () => {\n        if (!hasPerformanceNow || start === null) {\n          return Number.POSITIVE_INFINITY;\n        }\n        const elapsed = performance.now() - start;\n        return Math.max(0, this._thumbnailIdleBudgetMs - elapsed);\n      };\n\n    const shouldYield = () => timeRemaining() <= 1;\n\n    let processed = 0;\n    while (this._dirtyThumbnailLayerIds.size > 0) {\n      if (processed >= this._thumbnailBatchSize) {\n        break;\n      }\n\n      const iterator = this._dirtyThumbnailLayerIds.values().next();\n      if (iterator.done) {\n        break;\n      }\n      const layerId = iterator.value;\n      this._dirtyThumbnailLayerIds.delete(layerId);\n      this._updateLayerThumbnail(layerId);\n      processed++;\n\n      if (shouldYield()) {\n        break;\n      }\n    }\n  }\n\n  /**\n   * Schedules a flush using requestIdleCallback/requestAnimationFrame fallback\n   * @private\n   */\n  _scheduleThumbnailFlush() {\n    if (this._thumbnailFlushHandle !== null || this._dirtyThumbnailLayerIds.size === 0) {\n      return;\n    }\n\n    const flushCallback = (deadline) => {\n      this._thumbnailFlushHandle = null;\n      this._cancelThumbnailFlush = null;\n      this._flushDirtyThumbnails(deadline);\n      if (this._dirtyThumbnailLayerIds.size > 0) {\n        this._scheduleThumbnailFlush();\n      }\n    };\n\n    if (typeof window !== 'undefined' && typeof window.requestIdleCallback === 'function') {\n      this._thumbnailFlushHandle = window.requestIdleCallback(flushCallback);\n      this._cancelThumbnailFlush = (handle) => window.cancelIdleCallback(handle);\n    } else if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {\n      this._thumbnailFlushHandle = window.requestAnimationFrame(() => flushCallback());\n      this._cancelThumbnailFlush = (handle) => window.cancelAnimationFrame(handle);\n    } else {\n      this._thumbnailFlushHandle = setTimeout(() => flushCallback(), 16);\n      this._cancelThumbnailFlush = (handle) => clearTimeout(handle);\n    }\n  }\n\n  /**\n   * Updates thumbnails for a specific layer\n   * @private\n   */\n  _updateLayerThumbnail(layerId) {\n    this._dirtyThumbnailLayerIds.delete(layerId);\n    const layer = this.layerSystem.getLayers().find(l => l.id === layerId);\n    if (!layer) return;\n\n    const layerEl = this.layerElements.get(layerId);\n    if (!layerEl) return;\n\n    const canvas = layerEl.querySelector('.p5ml-thumbnail-canvas');\n    if (!canvas) return;\n\n    const ctx = canvas.getContext('2d');\n    if (!ctx) {\n      return;\n    }\n\n    const cacheEntry = this._getOrCreateThumbnailCacheEntry(layerId);\n    let sourceCanvas = cacheEntry.image && cacheEntry.image.canvas ? cacheEntry.image.canvas : null;\n    const needsCapture = this._captureNeeded.has(layerId) || !sourceCanvas;\n\n    if (needsCapture) {\n      const captured = this._captureLayerImage(layer);\n      if (captured && captured.canvas) {\n        cacheEntry.image = captured;\n        sourceCanvas = captured.canvas;\n        cacheEntry.boundsDirty = true;\n        this._captureNeeded.delete(layerId);\n      }\n    }\n\n    if (!sourceCanvas) {\n      return;\n    }\n\n    const previousSize = cacheEntry.lastSourceSize;\n    if (!previousSize || previousSize.width !== sourceCanvas.width || previousSize.height !== sourceCanvas.height) {\n      cacheEntry.window = [];\n    }\n    cacheEntry.lastSourceSize = { width: sourceCanvas.width, height: sourceCanvas.height };\n\n    if (this._thumbnailScratchCtx && (cacheEntry.boundsDirty || !cacheEntry.drawBounds)) {\n      const rawBounds = this._calculateBoundsFromCanvas(sourceCanvas);\n      // If first capture is empty, don't cache it - allow future updates\n      if (!rawBounds && !cacheEntry.drawBounds) {\n        cacheEntry.image = null;\n        return;\n      }\n      this._applyBoundsToCache(cacheEntry, rawBounds, sourceCanvas);\n      cacheEntry.boundsDirty = false;\n    } else if (!cacheEntry.drawBounds) {\n      cacheEntry.drawBounds = this._createFullBounds(sourceCanvas);\n      cacheEntry.boundsDirty = false;\n    }\n\n    const drawBounds = cacheEntry.drawBounds || this._createFullBounds(sourceCanvas);\n\n    const cropAmount = this._getCropAmount(sourceCanvas, drawBounds);\n    this._drawCheckerboard(ctx, canvas.width, canvas.height, cropAmount);\n    this._drawThumbnailImage(ctx, canvas, sourceCanvas, drawBounds);\n  }\n\n  _getOrCreateThumbnailCacheEntry(layerId) {\n    if (!this._thumbnailCache.has(layerId)) {\n      this._thumbnailCache.set(layerId, {\n        image: null,\n        boundsDirty: false,\n        window: [],\n        emptyFrames: 0,\n        drawBounds: null,\n        lastSourceSize: null\n      });\n    }\n    return this._thumbnailCache.get(layerId);\n  }\n\n  /**\n   * Lazily initializes a framebuffer for GPU-to-GPU downsampling.\n   * Uses p5.Framebuffer to stay in the same WebGL context as source framebuffers.\n   * @private\n   */\n  _getDownsampleBuffer(width, height) {\n    const p = this.layerSystem.p;\n    if (!p || typeof p.createFramebuffer !== 'function') {\n      return null;\n    }\n\n    // Create or resize the buffer as needed\n    if (!this._downsampleBuffer) {\n      try {\n        this._downsampleBuffer = p.createFramebuffer({\n          width,\n          height,\n          density: 1,\n          depthFormat: p.UNSIGNED_INT,\n          textureFiltering: p.LINEAR\n        });\n      } catch (e) {\n        console.debug('Could not create downsample framebuffer:', e);\n        return null;\n      }\n    } else if (this._downsampleBuffer.width !== width || this._downsampleBuffer.height !== height) {\n      this._downsampleBuffer.resize(width, height);\n    }\n\n    return this._downsampleBuffer;\n  }\n\n  /**\n   * Captures a downsampled image from a framebuffer using GPU-to-GPU copy.\n   * This avoids reading the full framebuffer, reducing readback from ~8MB to ~150KB.\n   * @private\n   */\n  _captureLayerImage(layer) {\n    const source = layer.framebuffer;\n    if (!source) {\n      return null;\n    }\n\n    const p = this.layerSystem.p;\n    if (!p) {\n      return null;\n    }\n\n    // Calculate downsampled dimensions\n    const maxSize = Math.max(1, this.options.thumbnailSampleMaxSize);\n    const sourceWidth = source.width || p.width;\n    const sourceHeight = source.height || p.height;\n    const largestSide = Math.max(sourceWidth, sourceHeight);\n    const scale = largestSide > maxSize ? maxSize / largestSide : 1;\n    const sampleWidth = Math.max(1, Math.round(sourceWidth * scale));\n    const sampleHeight = Math.max(1, Math.round(sourceHeight * scale));\n\n    try {\n      const buffer = this._getDownsampleBuffer(sampleWidth, sampleHeight);\n      if (!buffer) {\n        // Fallback to direct get() if buffer creation failed\n        if (typeof source.get === 'function') {\n          return source.get();\n        }\n        return null;\n      }\n\n      // GPU-to-GPU copy: render source framebuffer to small buffer\n      buffer.begin();\n      p.clear();\n      p.push();\n      p.imageMode(p.CORNER);\n      // Translate to top-left corner (WEBGL origin is center)\n      p.translate(-sampleWidth / 2, -sampleHeight / 2);\n      p.image(source, 0, 0, sampleWidth, sampleHeight);\n      p.pop();\n      buffer.end();\n\n      // Small readback: only ~150KB instead of ~8MB\n      const result = buffer.get();\n\n      // Store original dimensions for bounds scaling\n      result._originalWidth = sourceWidth;\n      result._originalHeight = sourceHeight;\n\n      return result;\n    } catch (e) {\n      console.debug('Could not capture downsampled thumbnail:', e);\n      // Fallback to direct get()\n      if (typeof source.get === 'function') {\n        return source.get();\n      }\n      return null;\n    }\n  }\n\n  _calculateBoundsFromCanvas(sourceCanvas) {\n    if (!this._thumbnailScratchCtx || !sourceCanvas.width || !sourceCanvas.height) {\n      return null;\n    }\n\n    const maxSize = Math.max(1, this.options.thumbnailSampleMaxSize);\n    const largestSide = Math.max(sourceCanvas.width, sourceCanvas.height);\n    const scale = largestSide > maxSize ? maxSize / largestSide : 1;\n    const sampleWidth = Math.max(1, Math.round(sourceCanvas.width * scale));\n    const sampleHeight = Math.max(1, Math.round(sourceCanvas.height * scale));\n\n    this._thumbnailScratchCanvas.width = sampleWidth;\n    this._thumbnailScratchCanvas.height = sampleHeight;\n\n    const ctx = this._thumbnailScratchCtx;\n    ctx.clearRect(0, 0, sampleWidth, sampleHeight);\n    ctx.drawImage(sourceCanvas, 0, 0, sampleWidth, sampleHeight);\n\n    let imageData;\n    try {\n      imageData = ctx.getImageData(0, 0, sampleWidth, sampleHeight);\n    } catch (e) {\n      console.debug('Could not read thumbnail buffer:', e);\n      return null;\n    }\n\n    const bounds = computeAlphaBounds(imageData.data, sampleWidth, sampleHeight, {\n      alphaThreshold: this.options.thumbnailAlphaThreshold,\n      stride: this.options.thumbnailSampleStride\n    });\n\n    if (!bounds) {\n      return null;\n    }\n\n    const scaleX = sourceCanvas.width / sampleWidth;\n    const scaleY = sourceCanvas.height / sampleHeight;\n    return {\n      x: bounds.x * scaleX,\n      y: bounds.y * scaleY,\n      width: bounds.width * scaleX,\n      height: bounds.height * scaleY\n    };\n  }\n\n  _applyBoundsToCache(cacheEntry, bounds, sourceSize) {\n    if (!cacheEntry) {\n      return;\n    }\n\n    // Only use sliding window smoothing when thumbnailAutoUpdate is true (every frame).\n    // With irregular updates (thumbnailUpdateEvery or click-only), use bounds directly.\n    const useSmoothing = this.options.thumbnailAutoUpdate;\n\n    if (!useSmoothing) {\n      // Direct mode: just use the current bounds with padding\n      if (bounds && bounds.width > 0 && bounds.height > 0) {\n        cacheEntry.drawBounds = padBounds(\n          bounds,\n          this.options.thumbnailPadding,\n          sourceSize.width,\n          sourceSize.height\n        );\n      } else if (!cacheEntry.drawBounds) {\n        cacheEntry.drawBounds = this._createFullBounds(sourceSize);\n      }\n      return;\n    }\n\n    // Smoothing mode: use sliding window for every-frame updates\n    if (!cacheEntry.window) {\n      cacheEntry.window = [];\n    }\n\n    if (bounds) {\n      cacheEntry.window.push(bounds);\n      const maxWindow = Math.max(1, this.options.thumbnailAnimationWindow || 0);\n      while (cacheEntry.window.length > maxWindow) {\n        cacheEntry.window.shift();\n      }\n      cacheEntry.emptyFrames = 0;\n    } else {\n      const resetLimit = Math.max(1, this.options.thumbnailEmptyFrameReset || 0);\n      cacheEntry.emptyFrames = (cacheEntry.emptyFrames || 0) + 1;\n      if (cacheEntry.emptyFrames >= resetLimit) {\n        cacheEntry.window = [];\n        cacheEntry.emptyFrames = resetLimit;\n      }\n    }\n\n    const merged = mergeBounds(cacheEntry.window);\n    const padded = merged\n      ? padBounds(merged, this.options.thumbnailPadding, sourceSize.width, sourceSize.height)\n      : null;\n\n    if (padded && padded.width > 0 && padded.height > 0) {\n      cacheEntry.drawBounds = padded;\n    } else if (!cacheEntry.drawBounds) {\n      cacheEntry.drawBounds = this._createFullBounds(sourceSize);\n    }\n\n    if (!cacheEntry.window.length) {\n      cacheEntry.drawBounds = this._createFullBounds(sourceSize);\n    }\n  }\n\n  _createFullBounds(sourceSize) {\n    const width = sourceSize.width || 0;\n    const height = sourceSize.height || 0;\n    return { x: 0, y: 0, width, height };\n  }\n\n  /**\n   * Returns a scalar in [0, 1] representing how tight the crop is.\n   * 0 = no crop (full layer), 1 = extremely tight crop (tiny region)\n   * @private\n   */\n  _getCropAmount(sourceCanvas, bounds) {\n    if (!sourceCanvas || !bounds || bounds.width <= 0 || bounds.height <= 0) {\n      return 0;\n    }\n\n    const layerWidth = sourceCanvas.width || 1;\n    const layerHeight = sourceCanvas.height || 1;\n    const areaLayer = layerWidth * layerHeight;\n    const areaCrop = bounds.width * bounds.height;\n\n    if (!Number.isFinite(areaLayer) || areaLayer <= 0) {\n      return 0;\n    }\n\n    const visibleFraction = Math.max(0, Math.min(1, areaCrop / areaLayer));\n    return 1 - visibleFraction;\n  }\n\n  _drawThumbnailImage(ctx, targetCanvas, sourceCanvas, bounds) {\n    if (!bounds || bounds.width <= 0 || bounds.height <= 0) {\n      return;\n    }\n\n    // Always fit the cropped region into the thumbnail while preserving aspect\n    const scale = Math.min(\n      targetCanvas.width / bounds.width,\n      targetCanvas.height / bounds.height\n    );\n\n    const destWidth = Math.max(1, bounds.width * scale);\n    const destHeight = Math.max(1, bounds.height * scale);\n    const destX = (targetCanvas.width - destWidth) / 2;\n    const destY = (targetCanvas.height - destHeight) / 2;\n\n    ctx.save();\n    ctx.imageSmoothingEnabled = false;\n    ctx.drawImage(\n      sourceCanvas,\n      bounds.x,\n      bounds.y,\n      bounds.width,\n      bounds.height,\n      destX,\n      destY,\n      destWidth,\n      destHeight\n    );\n    ctx.restore();\n  }\n\n  /**\n   * Creates a DOM element for a single layer\n   * @private\n   */\n  _createLayerElement(layer) {\n    const layerEl = document.createElement('div');\n    layerEl.className = 'p5ml-layer-item';\n    layerEl.dataset.layerId = layer.id;\n\n    // Add click handler to select layer and update thumbnail\n    const signal = this.layerSystem.p._removeSignal;\n    layerEl.addEventListener('click', (e) => {\n      // Close all dropdowns when clicking on the layer row itself\n      if (e.target.classList.contains('p5ml-layer-row') ||\n          e.target.classList.contains('p5ml-layer-name') ||\n          e.target.classList.contains('p5ml-layer-thumbnail') ||\n          e.target.classList.contains('p5ml-thumbnail-canvas')) {\n        this._closeAllDropdowns();\n        this._selectLayer(layer.id);\n        // Force capture on click so thumbnail updates with current layer content\n        this._captureNeeded.add(layer.id);\n        this._updateLayerThumbnail(layer.id);\n      }\n    }, { signal });\n\n    // Main layer row (Procreate style: thumbnail | name | blend letter | checkbox)\n    const layerRow = document.createElement('div');\n    layerRow.className = 'p5ml-layer-row';\n\n    // Left: Thumbnail\n    const thumbnail = this._createThumbnail();\n    thumbnail.className = 'p5ml-layer-thumbnail';\n    layerRow.appendChild(thumbnail);\n\n    // Center: Layer name\n    const nameSpan = document.createElement('span');\n    nameSpan.className = 'p5ml-layer-name';\n    nameSpan.textContent = layer.name;\n    layerRow.appendChild(nameSpan);\n\n    // Right side controls container\n    const rightControls = document.createElement('div');\n    rightControls.className = 'p5ml-right-controls';\n\n    // Blend mode letter indicator (clickable)\n    const blendIndicator = document.createElement('button');\n    blendIndicator.className = 'p5ml-blend-indicator';\n    blendIndicator.textContent = this._getBlendModeLetter(layer.blendMode);\n    blendIndicator.title = `Blend Mode: ${layer.blendMode}`;\n    blendIndicator.addEventListener('click', (e) => {\n      e.stopPropagation();\n      const dropdown = layerEl.querySelector('.p5ml-layer-dropdown');\n      const isExpanded = dropdown.style.display === 'block';\n\n      // Close all other dropdowns first\n      this._closeAllDropdowns();\n\n      // Toggle this dropdown (if it wasn't already open)\n      dropdown.style.display = isExpanded ? 'none' : 'block';\n    }, { signal });\n\n    // Visibility checkbox\n    const visibilityCheckbox = document.createElement('input');\n    visibilityCheckbox.type = 'checkbox';\n    visibilityCheckbox.className = 'p5ml-visibility-checkbox';\n    visibilityCheckbox.checked = layer.visible;\n    visibilityCheckbox.title = 'Toggle visibility';\n    visibilityCheckbox.addEventListener('change', (e) => {\n      e.stopPropagation();\n      if (e.target.checked) {\n        this.layerSystem.show(layer.id);\n      } else {\n        this.layerSystem.hide(layer.id);\n      }\n    }, { signal });\n\n    rightControls.appendChild(blendIndicator);\n    rightControls.appendChild(visibilityCheckbox);\n    layerRow.appendChild(rightControls);\n\n    // Dropdown panel (hidden by default, shown when blend indicator is clicked)\n    const dropdown = document.createElement('div');\n    dropdown.className = 'p5ml-layer-dropdown';\n    dropdown.style.display = 'none';\n\n    // Opacity control\n    const opacityGroup = document.createElement('div');\n    opacityGroup.className = 'p5ml-control-group';\n\n    const opacityLabel = document.createElement('label');\n    opacityLabel.textContent = 'OPACITY';\n\n    const opacityValue = document.createElement('span');\n    opacityValue.className = 'p5ml-opacity-value';\n    opacityValue.textContent = Math.round(layer.opacity * 100) + '%';\n\n    const opacitySlider = document.createElement('input');\n    opacitySlider.type = 'range';\n    opacitySlider.min = '0';\n    opacitySlider.max = '100';\n    opacitySlider.value = Math.round(layer.opacity * 100);\n    opacitySlider.className = 'p5ml-opacity-slider';\n    opacitySlider.addEventListener('input', (e) => {\n      e.stopPropagation();\n      const value = parseFloat(e.target.value) / 100;\n      this.layerSystem.setOpacity(layer.id, value);\n      opacityValue.textContent = e.target.value + '%';\n    }, { signal });\n\n    opacityGroup.appendChild(opacityLabel);\n    opacityGroup.appendChild(opacityValue);\n    opacityGroup.appendChild(opacitySlider);\n\n    // Blend mode control\n    const blendGroup = document.createElement('div');\n    blendGroup.className = 'p5ml-control-group';\n\n    const blendLabel = document.createElement('label');\n    blendLabel.textContent = 'BLEND MODE';\n\n    const blendSelect = document.createElement('select');\n    blendSelect.className = 'p5ml-blend-select';\n\n    Object.values(BlendModes).forEach(mode => {\n      const option = document.createElement('option');\n      option.value = mode;\n      option.textContent = this._formatBlendModeName(mode);\n      option.selected = layer.blendMode === mode;\n      blendSelect.appendChild(option);\n    });\n\n    blendSelect.addEventListener('change', (e) => {\n      e.stopPropagation();\n      this.layerSystem.setBlendMode(layer.id, e.target.value);\n      blendIndicator.textContent = this._getBlendModeLetter(e.target.value);\n      blendIndicator.title = `Blend Mode: ${e.target.value}`;\n    }, { signal });\n\n    blendGroup.appendChild(blendLabel);\n    blendGroup.appendChild(blendSelect);\n\n    dropdown.appendChild(opacityGroup);\n    dropdown.appendChild(blendGroup);\n\n    // Assemble layer element\n    layerEl.appendChild(layerRow);\n    layerEl.appendChild(dropdown);\n\n    return layerEl;\n  }\n\n  /**\n   * Gets a single letter representing the blend mode\n   * @private\n   */\n  _getBlendModeLetter(blendMode) {\n    const letters = {\n      [BlendModes.NORMAL]: 'N',\n      [BlendModes.MULTIPLY]: 'M',\n      [BlendModes.SCREEN]: 'S',\n      [BlendModes.OVERLAY]: 'O',\n      [BlendModes.DARKEN]: 'D',\n      [BlendModes.LIGHTEN]: 'Li',\n      [BlendModes.COLOR_DODGE]: 'Cd',\n      [BlendModes.COLOR_BURN]: 'B',\n      [BlendModes.HARD_LIGHT]: 'HL',\n      [BlendModes.SOFT_LIGHT]: 'SL',\n      [BlendModes.DIFFERENCE]: 'Di',\n      [BlendModes.EXCLUSION]: 'E',\n      [BlendModes.ADD]: 'A',\n      [BlendModes.SUBTRACT]: 'Su',\n    };\n    return letters[blendMode] || '-';\n  }\n\n  /**\n   * Formats blend mode name for display\n   * @private\n   */\n  _formatBlendModeName(mode) {\n    // Convert BLEND_MODE to \"Blend Mode\"\n    return mode.split('_')\n      .map(word => word.charAt(0) + word.slice(1).toLowerCase())\n      .join(' ');\n  }\n\n  /**\n   * Creates a thumbnail canvas for a framebuffer or image\n   * @private\n   */\n  _createThumbnail() {\n    const container = document.createElement('div');\n    container.className = 'p5ml-thumbnail';\n\n    const canvas = document.createElement('canvas');\n    canvas.className = 'p5ml-thumbnail-canvas';\n    canvas.width = 60;\n    canvas.height = 60;\n\n    const ctx = canvas.getContext('2d');\n\n    // Draw a checkerboard background for transparency\n    this._drawCheckerboard(ctx, canvas.width, canvas.height);\n\n    container.appendChild(canvas);\n    return container;\n  }\n\n\n  /**\n   * Draws a checkerboard pattern for transparency background\n   * @private\n   */\n  _drawCheckerboard(ctx, width, height, cropAmount = 0) {\n    if (!ctx) {\n      return;\n    }\n\n    const pattern = this._getCheckerPattern(ctx);\n    const scale = this._getCheckerboardScale(cropAmount);\n\n    if (pattern && typeof ctx.save === 'function') {\n      ctx.save();\n      ctx.fillStyle = pattern;\n      const cx = width / 2;\n      const cy = height / 2;\n      ctx.translate(cx, cy);\n      ctx.scale(scale, scale);\n      ctx.translate(-cx, -cy);\n      ctx.fillRect(0, 0, width, height);\n      ctx.restore();\n      return;\n    }\n\n    // Fallback: discrete checkerboard (used in tests/mocks without pattern support)\n    const baseSize = 8;\n    const squareSize = Math.max(2, Math.round(baseSize * scale));\n    ctx.fillStyle = '#333';\n    ctx.fillRect(0, 0, width, height);\n    ctx.fillStyle = '#444';\n\n    for (let y = 0; y < height; y += squareSize) {\n      for (let x = 0; x < width; x += squareSize) {\n        if ((x / squareSize + y / squareSize) % 2 === 0) {\n          ctx.fillRect(x, y, squareSize, squareSize);\n        }\n      }\n    }\n  }\n\n  _getCheckerboardScale(cropAmount = 0) {\n    const t = Math.max(0, Math.min(1, Number.isFinite(cropAmount) ? cropAmount : 0));\n    return 1 + t * 1.2; // Scale from 1.0 to 2.2 based on crop\n  }\n\n  _getCheckerPattern(ctx) {\n    if (!ctx || !this._checkerPatternCanvas || typeof ctx.createPattern !== 'function') {\n      return null;\n    }\n\n    if (this._checkerPatternCache && this._checkerPatternCache.has(ctx)) {\n      return this._checkerPatternCache.get(ctx);\n    }\n\n    const pattern = ctx.createPattern(this._checkerPatternCanvas, 'repeat');\n    if (pattern && this._checkerPatternCache) {\n      this._checkerPatternCache.set(ctx, pattern);\n    }\n    return pattern;\n  }\n\n  /**\n   * Selects a layer\n   * @private\n   */\n  _selectLayer(layerId) {\n    this.selectedLayerId = layerId;\n\n    // Update visual selection state\n    const elements = document.querySelectorAll('.p5ml-layer-item');\n\n    elements.forEach(el => {\n      // Convert both to strings for comparison (dataset values are always strings)\n      if (el.dataset.layerId == layerId) {\n        el.classList.add('p5ml-selected');\n        // Force bright blue background with inline style\n        el.style.background = '#3a7bc8';\n        el.style.borderLeft = '3px solid #5dade2';\n      } else {\n        el.classList.remove('p5ml-selected');\n        // Remove inline styles\n        el.style.background = '';\n        el.style.borderLeft = '';\n      }\n    });\n  }\n\n  /**\n   * Deselects the currently selected layer\n   * @private\n   */\n  _deselectLayer() {\n    this.selectedLayerId = null;\n\n    // Remove visual selection state from all layers\n    document.querySelectorAll('.p5ml-layer-item').forEach(el => {\n      el.classList.remove('p5ml-selected');\n      // Remove inline styles\n      el.style.background = '';\n      el.style.borderLeft = '';\n    });\n  }\n\n  /**\n   * Moves the selected layer up or down in the stack\n   * @private\n   * @param {number} direction - -1 for up (higher in stack), 1 for down (lower in stack)\n   */\n  _moveSelectedLayer(direction) {\n    if (this.selectedLayerId === null) return;\n\n    const layers = this.layerSystem.getLayers();\n    const currentIndex = layers.findIndex(l => l.id === this.selectedLayerId);\n\n    if (currentIndex === -1) return;\n\n    // Calculate new index (remember layers are in bottom-to-top order)\n    // direction -1 means \"up\" which is higher index\n    // direction 1 means \"down\" which is lower index\n    const newIndex = currentIndex - direction;\n\n    // Check bounds\n    if (newIndex < 0 || newIndex >= layers.length) return;\n\n    // Swap layers\n    const targetLayer = layers[newIndex];\n\n    // Swap entries inside the layer array\n    [layers[currentIndex], layers[newIndex]] = [layers[newIndex], layers[currentIndex]];\n\n    // Move only the affected DOM nodes instead of rebuilding the entire list\n    const selectedElement = this.layerElements.get(this.selectedLayerId);\n    const targetElement = this.layerElements.get(targetLayer.id);\n    if (selectedElement && targetElement && this.layersContainer) {\n      if (direction === -1) {\n        this.layersContainer.insertBefore(selectedElement, targetElement);\n      } else {\n        const nextNode = targetElement.nextSibling;\n        this.layersContainer.insertBefore(selectedElement, nextNode);\n      }\n    }\n\n    // Only the swapped layers need their thumbnails refreshed\n    this._markThumbnailsDirty([this.selectedLayerId, targetLayer.id]);\n\n    // Update the layer system's internal order\n    if (typeof this.layerSystem.reorderLayers === 'function') {\n      this.layerSystem.reorderLayers(layers);\n    }\n\n    // Re-select the layer to keep the highlight consistent\n    this._selectLayer(this.selectedLayerId);\n  }\n\n  /**\n   * Attaches CSS styles to the document\n   * @private\n   */\n  _attachStyles() {\n    // Check if styles already exist\n    if (document.getElementById('p5ml-layer-ui-styles')) {\n      return;\n    }\n\n    const style = document.createElement('style');\n    style.id = 'p5ml-layer-ui-styles';\n    style.textContent = `\n      .p5ml-layer-panel {\n        position: fixed;\n        background: rgba(26, 26, 26, 0.95);\n        border: 1px solid #444;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        font-size: 13px;\n        color: #e0e0e0;\n        z-index: 10000;\n        backdrop-filter: blur(10px);\n        overflow: hidden;\n      }\n\n      .p5ml-layer-panel.collapsed .p5ml-layers-container {\n        display: none;\n      }\n\n      .p5ml-panel-header {\n        background: rgba(60, 60, 60, 0.9);\n        padding: 12px 16px;\n        border-bottom: 1px solid #333;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        user-select: none;\n      }\n\n      .p5ml-panel-title {\n        font-weight: 600;\n        font-size: 16px;\n        letter-spacing: 0.5px;\n        color: #ccc;\n      }\n\n      .p5ml-header-controls {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .p5ml-arrow-btn {\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        border-radius: 4px;\n        color: #e8e8e8;\n        font-size: 16px;\n        cursor: pointer;\n        padding: 4px 8px;\n        width: 28px;\n        height: 28px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.15s;\n      }\n\n      .p5ml-arrow-btn:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.3);\n      }\n\n      .p5ml-arrow-btn:active {\n        background: rgba(255, 255, 255, 0.2);\n      }\n\n      .p5ml-collapse-btn {\n        background: none;\n        border: none;\n        color: #aaa;\n        font-size: 18px;\n        cursor: pointer;\n        padding: 0;\n        width: 20px;\n        height: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .p5ml-collapse-btn:hover {\n        color: #fff;\n      }\n\n      .p5ml-layers-container {\n        max-height: 500px;\n        overflow-y: auto;\n        padding: 0;\n        background: #2a2a2a;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.2);\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 4px;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      /* Procreate-style layer item */\n      .p5ml-layer-item {\n        background: transparent;\n        border-bottom: 1px solid #3a3a3a;\n        transition: background 0.15s ease;\n        cursor: pointer;\n      }\n\n      .p5ml-layer-item:hover {\n        background: rgba(100, 150, 255, 0.15);\n      }\n\n      /* Selected state */\n      .p5ml-layer-item.p5ml-selected {\n        background: #3a7bc8 !important;\n        border-left: 3px solid #5dade2;\n      }\n\n      .p5ml-layer-item.p5ml-selected:hover {\n        background: #4a8dd8 !important;\n      }\n\n      .p5ml-layer-item.p5ml-selected .p5ml-layer-row {\n        background: transparent;\n      }\n\n      /* Main layer row (horizontal layout) */\n      .p5ml-layer-row {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 10px 12px;\n      }\n\n      /* Thumbnail on the left */\n      .p5ml-layer-thumbnail {\n        flex-shrink: 0;\n      }\n\n      .p5ml-layer-thumbnail canvas {\n        display: block;\n        width: 60px;\n        height: 60px;\n        border: 1px solid #555;\n        border-radius: 4px;\n        image-rendering: pixelated;\n      }\n\n      /* Layer name in center */\n      .p5ml-layer-name {\n        flex: 1;\n        font-weight: 500;\n        font-size: 15px;\n        color: #e8e8e8;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      /* Right side controls */\n      .p5ml-right-controls {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        flex-shrink: 0;\n      }\n\n      /* Blend mode letter indicator */\n      .p5ml-blend-indicator {\n        width: 28px;\n        height: 28px;\n        border-radius: 4px;\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        color: #e8e8e8;\n        font-weight: 600;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.15s;\n        pointer-events: auto;\n      }\n\n      .p5ml-blend-indicator:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.3);\n      }\n\n      /* Visibility checkbox */\n      .p5ml-visibility-checkbox {\n        width: 20px;\n        height: 20px;\n        cursor: pointer;\n        accent-color: #4a90e2;\n        pointer-events: auto;\n      }\n\n      /* Dropdown panel for opacity and blend mode */\n      .p5ml-layer-dropdown {\n        background: rgba(40, 40, 40, 0.95);\n        border-top: 1px solid #555;\n        padding: 16px;\n        display: none;\n      }\n\n      .p5ml-control-group {\n        margin-bottom: 16px;\n      }\n\n      .p5ml-control-group:last-child {\n        margin-bottom: 0;\n      }\n\n      .p5ml-control-group label {\n        font-size: 11px;\n        color: #999;\n        text-transform: uppercase;\n        letter-spacing: 0.8px;\n        font-weight: 600;\n        display: flex;\n        justify-content: space-between;\n        margin-bottom: 8px;\n      }\n\n      .p5ml-opacity-value {\n        color: #e0e0e0;\n        font-weight: 600;\n      }\n\n      .p5ml-opacity-slider {\n        width: 100%;\n        height: 6px;\n        border-radius: 3px;\n        outline: none;\n        -webkit-appearance: none;\n        background: rgba(255, 255, 255, 0.15);\n        margin-top: 4px;\n      }\n\n      .p5ml-opacity-slider::-webkit-slider-thumb {\n        -webkit-appearance: none;\n        appearance: none;\n        width: 18px;\n        height: 18px;\n        border-radius: 50%;\n        background: #fff;\n        cursor: pointer;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .p5ml-opacity-slider::-moz-range-thumb {\n        width: 18px;\n        height: 18px;\n        border-radius: 50%;\n        background: #fff;\n        cursor: pointer;\n        border: none;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .p5ml-blend-select {\n        width: 100%;\n        background: rgba(0, 0, 0, 0.4);\n        border: 1px solid #555;\n        border-radius: 6px;\n        color: #e8e8e8;\n        padding: 10px 12px;\n        font-size: 14px;\n        cursor: pointer;\n        outline: none;\n        margin-top: 4px;\n      }\n\n      .p5ml-blend-select:hover {\n        border-color: #777;\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      .p5ml-blend-select option {\n        background: #2a2a2a;\n        color: #e8e8e8;\n        padding: 8px;\n      }\n\n      /* Hide old thumbnail styles - no longer used */\n      .p5ml-thumbnail-label {\n        display: none;\n      }\n    `;\n\n    document.head.appendChild(style);\n  }\n\n  /**\n   * Toggles the collapsed state of the panel\n   */\n  toggle() {\n    this.isCollapsed = !this.isCollapsed;\n    this.container.classList.toggle('collapsed', this.isCollapsed);\n\n    const btn = this.container.querySelector('.p5ml-collapse-btn');\n    if (btn) {\n      btn.innerHTML = this.isCollapsed ? '+' : '−';\n    }\n  }\n\n  /**\n   * Shows the panel\n   */\n  show() {\n    this.container.style.display = 'block';\n  }\n\n  /**\n   * Hides the panel\n   */\n  hide() {\n    this.container.style.display = 'none';\n  }\n\n  /**\n   * Removes the panel from the DOM\n   */\n  dispose() {\n    if (this.container && this.container.parentNode) {\n      this.container.parentNode.removeChild(this.container);\n    }\n\n    if (this._cancelThumbnailFlush && this._thumbnailFlushHandle !== null) {\n      this._cancelThumbnailFlush(this._thumbnailFlushHandle);\n    }\n    this._dirtyThumbnailLayerIds.clear();\n    this._captureNeeded.clear();\n    this._thumbnailCache.clear();\n    this._thumbnailFlushHandle = null;\n    this._cancelThumbnailFlush = null;\n    this._thumbnailScratchCanvas = null;\n    this._thumbnailScratchCtx = null;\n  }\n}\n","import { Layer } from './Layer.js';\nimport { Compositor } from './Compositor.js';\nimport { BlendModes } from './constants.js';\nimport { LayerUI } from './LayerUI.js';\n\n/**\n * Main layer system manager\n */\nexport class LayerSystem {\n  /**\n   * @param {p5} p5Instance - The p5.js instance\n   */\n  constructor(p5Instance) {\n    this.p = p5Instance;\n\n    // Validate WebGL mode\n    if (!this.p._renderer || !this.p._renderer.drawingContext) {\n      throw new Error('Canvas not initialized. Make sure createCanvas() is called before createLayerSystem()');\n    }\n\n    if (this.p._renderer.drawingContext instanceof WebGLRenderingContext ||\n        this.p._renderer.drawingContext instanceof WebGL2RenderingContext) {\n      // WebGL mode confirmed\n    } else {\n      throw new Error('LayerSystem requires WebGL mode. Use createCanvas(w, h, WEBGL)');\n    }\n\n    this.layers = new Map(); // id -> Layer\n    this.layerNames = new Map(); // name -> id (for string-based lookups)\n    this.layerIdCounter = 0;\n    this.activeLayerId = null;\n    this.compositor = new Compositor(p5Instance);\n    this.ui = null; // LayerUI instance\n\n    // Track if we're auto-resizing\n    this.autoResize = true;\n    this._lastCanvasWidth = this.p.width;\n    this._lastCanvasHeight = this.p.height;\n    this._lastPixelDensity = this.p.pixelDensity();\n  }\n\n  /**\n   * Generates a unique layer ID\n   * @private\n   */\n  _generateId() {\n    return this.layerIdCounter++;\n  }\n\n  /**\n   * Gets a layer by ID or name\n   * @private\n   * @param {number|string} layerIdOrName - The layer ID (number) or name (string)\n   * @returns {Layer|null} The layer, or null if not found\n   */\n  _getLayerById(layerIdOrName) {\n    // If it's a number, look up directly by ID\n    if (typeof layerIdOrName === 'number') {\n      return this.layers.get(layerIdOrName) || null;\n    }\n    \n    // If it's a string, look up by name first\n    if (typeof layerIdOrName === 'string') {\n      const id = this.layerNames.get(layerIdOrName);\n      if (id !== undefined) {\n        return this.layers.get(id) || null;\n      }\n    }\n    \n    return null;\n  }\n\n  /**\n   * Creates a new layer\n   * @param {string} name - Optional name for the layer\n   * @param {Object} options - Layer configuration options\n   * @returns {Layer} The created layer instance\n   */\n  createLayer(name = '', options = {}) {\n    const id = this._generateId();\n    const layerName = name || `Layer ${id}`;\n    const layer = new Layer(this.p, id, layerName, {\n      ...options,\n      zIndex: options.zIndex !== undefined ? options.zIndex : id\n    });\n\n    this.layers.set(id, layer);\n    \n    // Register the name for string-based lookups\n    if (layerName) {\n      this.layerNames.set(layerName, id);\n    }\n    \n    return layer;\n  }\n\n  /**\n   * Removes a layer and disposes of its resources\n   * @param {number|string} layerIdOrName - The ID or name of the layer to remove\n   */\n  removeLayer(layerIdOrName) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return;\n    }\n\n    // If this layer is currently active, end it\n    if (this.activeLayerId === layer.id) {\n      this.end();\n    }\n\n    // Remove from name map if it has a name\n    if (layer.name) {\n      this.layerNames.delete(layer.name);\n    }\n\n    layer.dispose();\n    this.layers.delete(layer.id);\n  }\n\n  /**\n   * Gets a layer by ID or name\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @returns {Layer|null} The layer, or null if not found\n   */\n  getLayer(layerIdOrName) {\n    return this._getLayerById(layerIdOrName);\n  }\n\n  /**\n   * Gets all layers as an array, sorted by zIndex\n   * @returns {Layer[]} Array of layers\n   */\n  getLayers() {\n    return Array.from(this.layers.values()).sort((a, b) => a.zIndex - b.zIndex);\n  }\n\n  /**\n   * Gets layer information as plain objects\n   * @returns {Object[]} Array of layer info objects\n   */\n  getLayerInfo() {\n    return this.getLayers().map(layer => layer.toJSON());\n  }\n\n  /**\n   * Begins drawing to a specific layer\n   * @param {number|string} layerIdOrName - The ID or name of the layer to draw to\n   */\n  begin(layerIdOrName) {\n    // Check if another layer is already active\n    if (this.activeLayerId !== null) {\n      console.warn(`Layer ${this.activeLayerId} is already active. Ending it first.`);\n      this.end();\n    }\n\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.error(`Layer ${layerIdOrName} not found`);\n      return;\n    }\n\n    layer.begin();\n    this.activeLayerId = layer.id;\n  }\n\n  /**\n   * Ends drawing to the current layer\n   */\n  end() {\n    if (this.activeLayerId === null) {\n      console.warn('No active layer to end');\n      return;\n    }\n\n    const layer = this.layers.get(this.activeLayerId);\n    if (layer) {\n      layer.end();\n\n      if (this.ui && typeof this.ui.scheduleThumbnailUpdate === 'function') {\n        this.ui.scheduleThumbnailUpdate(layer.id, { needsCapture: true });\n      }\n    }\n\n    this.activeLayerId = null;\n  }\n\n  /**\n   * Shows a layer (makes it visible)\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @returns {Layer|null} The layer for chaining, or null if not found\n   */\n  show(layerIdOrName) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return null;\n    }\n    return layer.show();\n  }\n\n  /**\n   * Hides a layer (makes it invisible)\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @returns {Layer|null} The layer for chaining, or null if not found\n   */\n  hide(layerIdOrName) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return null;\n    }\n    return layer.hide();\n  }\n\n  /**\n   * Sets the opacity of a layer\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @param {number} opacity - Opacity value between 0 and 1\n   * @returns {Layer|null} The layer for chaining, or null if not found\n   */\n  setOpacity(layerIdOrName, opacity) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return null;\n    }\n    return layer.setOpacity(opacity);\n  }\n\n  /**\n   * Sets the blend mode of a layer\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @param {string} blendMode - One of the BlendModes constants\n   * @returns {Layer|null} The layer for chaining, or null if not found\n   */\n  setBlendMode(layerIdOrName, blendMode) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return null;\n    }\n    return layer.setBlendMode(blendMode);\n  }\n\n  /**\n   * Sets the z-index of a layer\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @param {number} zIndex - The new z-index (higher = on top)\n   * @returns {Layer|null} The layer for chaining, or null if not found\n   */\n  setLayerIndex(layerIdOrName, zIndex) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return null;\n    }\n    return layer.setZIndex(zIndex);\n  }\n\n  /**\n   * Moves a layer by a relative amount in the stack\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @param {number} delta - The amount to move (positive = forward, negative = backward)\n   * @returns {Layer|null} The layer for chaining, or null if not found\n   */\n  moveLayer(layerIdOrName, delta) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return null;\n    }\n    return layer.setZIndex(layer.zIndex + delta);\n  }\n\n  /**\n   * Reorders layers to match a new array order\n   * @param {Layer[]} orderedLayers - Array of layers in the desired order\n   */\n  reorderLayers(orderedLayers) {\n    // Update zIndex for each layer based on its position in the array\n    orderedLayers.forEach((layer, index) => {\n      layer.setZIndex(index);\n    });\n  }\n\n  /**\n   * Attaches a mask to a layer\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @param {p5.Framebuffer|p5.Image} maskSource - The mask to apply\n   * @returns {Layer|null} The layer for chaining, or null if not found\n   */\n  setMask(layerIdOrName, maskSource) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return null;\n    }\n    return layer.setMask(maskSource);\n  }\n\n  /**\n   * Removes the mask from a layer\n   * @param {number|string} layerIdOrName - The layer ID or name\n   * @returns {Layer|null} The layer for chaining, or null if not found\n   */\n  clearMask(layerIdOrName) {\n    const layer = this._getLayerById(layerIdOrName);\n    if (!layer) {\n      console.warn(`Layer ${layerIdOrName} not found`);\n      return null;\n    }\n    return layer.clearMask();\n  }\n\n  /**\n   * Renders all layers to the main canvas\n   * @param {Function} clearCallback - Optional callback to clear the canvas before rendering\n   */\n  render(clearCallback = null) {\n    // Check for canvas resize\n    if (this.autoResize) {\n      this._checkResize();\n    }\n\n    const layers = this.getLayers();\n    this.compositor.render(layers, clearCallback);\n\n    // Sync UI state if UI exists\n    if (this.ui) {\n      this.ui.syncState();\n    }\n  }\n\n  /**\n   * Checks if canvas was resized and updates layers accordingly\n   * @private\n   */\n  _checkResize() {\n    const currentWidth = this.p.width;\n    const currentHeight = this.p.height;\n    const currentDensity = this.p.pixelDensity();\n\n    const sizeChanged = currentWidth !== this._lastCanvasWidth ||\n      currentHeight !== this._lastCanvasHeight;\n    const densityChanged = currentDensity !== this._lastPixelDensity;\n\n    if (!sizeChanged && !densityChanged) {\n      return;\n    }\n\n    this._lastCanvasWidth = currentWidth;\n    this._lastCanvasHeight = currentHeight;\n    this._lastPixelDensity = currentDensity;\n\n    // Resize all canvas-synced layers\n    for (const layer of this.layers.values()) {\n      if (!layer.customSize) {\n        layer.resize(currentWidth, currentHeight, currentDensity);\n      }\n    }\n  }\n\n  /**\n   * Enables or disables automatic layer resizing when canvas size changes\n   * @param {boolean} enabled - Whether to enable auto-resize\n   */\n  setAutoResize(enabled) {\n    this.autoResize = !!enabled;\n  }\n\n  /**\n   * Creates and shows a UI panel for controlling layers\n   * @param {Object} options - UI configuration options\n   * @returns {LayerUI} The created UI instance\n   */\n  createUI(options = {}) {\n    // Dispose existing UI if any\n    if (this.ui) {\n      this.ui.dispose();\n    }\n\n    this.ui = new LayerUI(this, options);\n    this.ui.update();\n    return this.ui;\n  }\n\n  /**\n   * Updates the UI if it exists\n   */\n  updateUI() {\n    if (this.ui) {\n      this.ui.update();\n    }\n  }\n\n  /**\n   * Disposes of all layers and resources\n   */\n  dispose() {\n    // End active layer if any\n    if (this.activeLayerId !== null) {\n      this.end();\n    }\n\n    // Dispose UI if exists\n    if (this.ui) {\n      this.ui.dispose();\n      this.ui = null;\n    }\n\n    // Dispose all layers\n    for (const layer of this.layers.values()) {\n      layer.dispose();\n    }\n\n    this.layers.clear();\n    this.compositor.dispose();\n  }\n}\n","/**\n * p5.millefeuille - A Photoshop-like layer system for p5.js WebGL\n *\n * @module p5.millefeuille\n */\n\nimport { LayerSystem } from './LayerSystem.js';\nimport { BlendModes as BlendModesEnum } from './constants.js';\n\nexport { Layer } from './Layer.js';\nexport { Compositor } from './Compositor.js';\nexport { LayerUI } from './LayerUI.js';\nexport { BlendModes, getBlendModeIndex, DEFAULT_LAYER_OPTIONS } from './constants.js';\n\n// Version\nexport const VERSION = '0.2.1';\n\n/**\n * p5.js addon registration function\n * @param {object} p5 - The p5 constructor\n * @param {object} fn - The p5 prototype\n * @param {object} lifecycles - Lifecycle hooks\n */\nfunction millefeuilleAddon(p5, fn, lifecycles) {\n  // Attach createLayerSystem to p5 prototype\n  fn.createLayerSystem = function(options = {}) {\n    // 'this' is the p5 instance\n    return new LayerSystem(this, options);\n  };\n\n  // Cleanup lifecycle - dispose layer system when sketch is removed\n  if (lifecycles) {\n    lifecycles.remove = function() {\n      if (this._layerSystem) {\n        this._layerSystem.dispose();\n        this._layerSystem = null;\n      }\n    };\n  }\n}\n\n// Auto-register for script tag usage\nif (typeof window !== 'undefined' && typeof window.p5 !== 'undefined') {\n  window.p5.registerAddon(millefeuilleAddon);\n  \n  // Also expose common utilities globally for convenience\n  window.BlendModes = BlendModesEnum;\n}\n\n// Export addon function as default for ESM usage\nexport default millefeuilleAddon;\n\n// Also export LayerSystem for direct instantiation if needed\nexport { LayerSystem };\n"],"names":["BlendModes","NORMAL","MULTIPLY","SCREEN","ADD","SUBTRACT","OVERLAY","SOFT_LIGHT","HARD_LIGHT","COLOR_DODGE","COLOR_BURN","DARKEN","LIGHTEN","DIFFERENCE","EXCLUSION","getBlendModeIndex","mode","console","warn","DEFAULT_LAYER_OPTIONS","visible","opacity","blendMode","width","height","density","depth","antialias","Layer","constructor","p5Instance","id","name","options","this","p","opts","_clampOpacity","zIndex","undefined","pixelDensity","customSize","mask","hasBeenDrawnTo","framebuffer","_createFramebuffer","Error","createFramebuffer","e","error","value","Math","max","min","show","hide","setOpacity","setBlendMode","Object","values","includes","setZIndex","setMask","maskSource","clearMask","resize","matchesCanvas","remove","begin","end","dispose","toJSON","hasMask","Compositor","shader","shaderLoaded","bufferA","bufferB","_bufferDensity","_ensureShader","createShader","_ensureBuffers","currentDensity","bufferOptions","a","b","_renderLayer","layer","backgroundBuffer","push","BLEND","setUniform","imageMode","CENTER","rectMode","noStroke","fill","rect","resetShader","pop","render","layers","clearCallback","buffers","currentBuffer","nextBuffer","sortedLayers","sort","clear","i","length","temp","image","padBounds","bounds","padding","maxWidth","maxHeight","x","y","clampBounds","LayerUI","layerSystem","position","collapsible","draggable","thumbnailPadding","thumbnailSampleMaxSize","thumbnailAlphaThreshold","thumbnailAnimationWindow","thumbnailEmptyFrameReset","thumbnailSampleStride","thumbnailAutoUpdate","thumbnailUpdateEvery","isCollapsed","container","layerElements","Map","selectedLayerId","_dirtyThumbnailLayerIds","Set","_captureNeeded","_thumbnailCache","_thumbnailFlushHandle","_cancelThumbnailFlush","_thumbnailBatchSize","_thumbnailIdleBudgetMs","_thumbnailScratchCanvas","document","createElement","_thumbnailScratchCtx","getContext","imageSmoothingEnabled","_downsampleBuffer","_checkerPatternCanvas","_checkerPatternCache","WeakMap","size","checkerCtx","fillStyle","fillRect","_createUI","_attachStyles","className","style","header","innerHTML","appendChild","layersContainer","body","_positionPanel","signal","_removeSignal","collapseBtn","querySelector","addEventListener","toggle","stopPropagation","upBtn","downBtn","_moveSelectedLayer","_makeDraggable","contains","target","_closeAllDropdowns","_deselectLayer","key","repeat","_isPanelVisible","matches","preventDefault","querySelectorAll","forEach","d","display","positions","top","right","left","bottom","pos","assign","getClientRects","offsetX","offsetY","isDragging","cursor","getBoundingClientRect","clientX","clientY","newX","newY","panelWidth","offsetWidth","viewportWidth","window","innerWidth","viewportHeight","innerHeight","minVisible","update","getLayers","_pruneThumbnailState","reversedLayers","reverse","layerEl","_createLayerElement","set","_markThumbnailsDirty","map","needsCapture","scheduleThumbnailUpdate","layerId","syncState","get","checkbox","checked","opacitySlider","opacityValue","opacityPercent","round","textContent","blendSelect","blendIndicator","_getBlendModeLetter","title","layerIds","ids","Array","isArray","shouldSchedule","isUpdateFrame","updateEvery","frameCount","cacheEntry","hasThumbnail","add","_scheduleThumbnailFlush","activeLayers","liveIds","from","keys","has","delete","_flushDirtyThumbnails","deadline","hasPerformanceNow","performance","now","start","timeRemaining","Number","POSITIVE_INFINITY","elapsed","shouldYield","processed","iterator","next","done","_updateLayerThumbnail","flushCallback","requestIdleCallback","handle","cancelIdleCallback","requestAnimationFrame","cancelAnimationFrame","setTimeout","clearTimeout","find","l","canvas","ctx","_getOrCreateThumbnailCacheEntry","sourceCanvas","captured","_captureLayerImage","boundsDirty","previousSize","lastSourceSize","drawBounds","_createFullBounds","rawBounds","_calculateBoundsFromCanvas","_applyBoundsToCache","cropAmount","_getCropAmount","_drawCheckerboard","_drawThumbnailImage","emptyFrames","_getDownsampleBuffer","depthFormat","UNSIGNED_INT","textureFiltering","LINEAR","debug","source","maxSize","sourceWidth","sourceHeight","largestSide","scale","sampleWidth","sampleHeight","buffer","CORNER","translate","result","_originalWidth","_originalHeight","imageData","clearRect","drawImage","getImageData","pixels","threshold","isFinite","alphaThreshold","stride","floor","minX","minY","maxX","maxY","rowOffset","computeAlphaBounds","data","scaleX","scaleY","sourceSize","maxWindow","shift","resetLimit","merged","boundsList","NEGATIVE_INFINITY","found","mergeBounds","padded","areaLayer","areaCrop","targetCanvas","destWidth","destHeight","destX","destY","save","restore","dataset","classList","_selectLayer","layerRow","thumbnail","_createThumbnail","nameSpan","rightControls","dropdown","isExpanded","visibilityCheckbox","type","opacityGroup","opacityLabel","parseFloat","blendGroup","blendLabel","option","_formatBlendModeName","selected","split","word","charAt","slice","toLowerCase","join","pattern","_getCheckerPattern","_getCheckerboardScale","cx","cy","squareSize","createPattern","el","background","borderLeft","direction","currentIndex","findIndex","newIndex","targetLayer","selectedElement","targetElement","insertBefore","nextNode","nextSibling","reorderLayers","getElementById","head","btn","parentNode","removeChild","LayerSystem","_renderer","drawingContext","WebGLRenderingContext","WebGL2RenderingContext","layerNames","layerIdCounter","activeLayerId","compositor","ui","autoResize","_lastCanvasWidth","_lastCanvasHeight","_lastPixelDensity","_generateId","_getLayerById","layerIdOrName","createLayer","layerName","removeLayer","getLayer","getLayerInfo","setLayerIndex","moveLayer","delta","orderedLayers","index","_checkResize","currentWidth","currentHeight","sizeChanged","densityChanged","setAutoResize","enabled","createUI","updateUI","millefeuilleAddon","p5","fn","lifecycles","createLayerSystem","_layerSystem","registerAddon","BlendModesEnum"],"mappings":"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"}