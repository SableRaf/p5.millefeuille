const BlendModes={NORMAL:"NORMAL",MULTIPLY:"MULTIPLY",SCREEN:"SCREEN",ADD:"ADD",SUBTRACT:"SUBTRACT"};function getP5BlendMode(e,t){const n=t;switch(e){case BlendModes.NORMAL:return n.BLEND;case BlendModes.MULTIPLY:return n.MULTIPLY;case BlendModes.SCREEN:return n.LIGHTEST;case BlendModes.ADD:return n.ADD;case BlendModes.SUBTRACT:return n.SUBTRACT;default:return console.warn(`Unknown blend mode: ${e}, falling back to NORMAL`),n.BLEND}}const DEFAULT_LAYER_OPTIONS={visible:!0,opacity:1,blendMode:BlendModes.NORMAL,width:null,height:null,density:null,depth:!1,antialias:!1};class Layer{constructor(e,t,n="",a={}){this.p=e,this.id=t,this.name=n||`Layer ${t}`;const r={...DEFAULT_LAYER_OPTIONS,...a};if(this.visible=r.visible,this.opacity=this._clampOpacity(r.opacity),this.blendMode=r.blendMode,this.zIndex=void 0!==r.zIndex?r.zIndex:t,this.width=r.width||this.p.width,this.height=r.height||this.p.height,this.density=r.density||this.p.pixelDensity(),this.depth=r.depth,this.antialias=r.antialias,this.mask=null,this.framebuffer=this._createFramebuffer(),!this.framebuffer)throw new Error(`Failed to create framebuffer for layer ${this.name}`)}_createFramebuffer(){try{const e={width:this.width,height:this.height,density:this.density};return void 0!==this.depth&&(e.depth=this.depth),void 0!==this.antialias&&(e.antialias=this.antialias),this.p.createFramebuffer(e)}catch(e){return console.error(`Error creating framebuffer for layer ${this.name}:`,e),null}}_clampOpacity(e){return Math.max(0,Math.min(1,e))}setVisible(e){this.visible=!!e}setOpacity(e){this.opacity=this._clampOpacity(e)}setBlendMode(e){Object.values(BlendModes).includes(e)?this.blendMode=e:(console.warn(`Invalid blend mode: ${e}, using NORMAL`),this.blendMode=BlendModes.NORMAL)}setZIndex(e){this.zIndex=e}setMask(e){e?this.mask=e:console.warn("Invalid mask source provided")}clearMask(){this.mask=null}resize(e,t){this.width=e,this.height=t,this.framebuffer&&this.framebuffer.remove(),this.framebuffer=this._createFramebuffer()}begin(){this.framebuffer?this.framebuffer.begin():console.error(`Cannot begin drawing: framebuffer not initialized for layer ${this.name}`)}end(){this.framebuffer?this.framebuffer.end():console.error(`Cannot end drawing: framebuffer not initialized for layer ${this.name}`)}dispose(){this.framebuffer&&(this.framebuffer.remove(),this.framebuffer=null)}toJSON(){return{id:this.id,name:this.name,visible:this.visible,opacity:this.opacity,blendMode:this.blendMode,zIndex:this.zIndex,hasMask:!!this.mask,width:this.width,height:this.height}}}var compositorVertSource="precision highp float;\n\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\n\nvoid main() {\n  // Pass through texture coordinates\n  vTexCoord = aTexCoord;\n\n  // Standard vertex transformation\n  vec4 positionVec4 = vec4(aPosition, 1.0);\n  positionVec4.xy = positionVec4.xy * 2.0 - 1.0;\n  gl_Position = positionVec4;\n}\n",compositorFragSource="precision highp float;\n\nvarying vec2 vTexCoord;\n\nuniform sampler2D layerTexture;\nuniform sampler2D maskTexture;\nuniform bool hasMask;\nuniform float layerOpacity;\n\nvoid main() {\n  // Flip y-coordinate for p5.js texture coordinate system\n  vec2 uv = vec2(vTexCoord.x, 1.0 - vTexCoord.y);\n\n  // Sample the layer texture\n  vec4 layerColor = texture2D(layerTexture, uv);\n\n  // Calculate final opacity\n  float finalOpacity = layerOpacity;\n\n  // Apply mask if present\n  if (hasMask) {\n    vec4 maskColor = texture2D(maskTexture, uv);\n    // Use the red channel of the mask as alpha (grayscale mask)\n    // Could also use maskColor.a for alpha channel masks\n    float maskValue = maskColor.r;\n    finalOpacity *= maskValue;\n  }\n\n  // Apply opacity to the layer color (including RGB channels for proper alpha blending)\n  // This ensures proper pre-multiplied alpha behavior\n  layerColor.rgb *= finalOpacity;\n  layerColor.a *= finalOpacity;\n\n  gl_FragColor = layerColor;\n}\n";class Compositor{constructor(e){this.p=e,this.shader=null,this.shaderLoaded=!1}_ensureShader(){if(!this.shaderLoaded)try{this.shader=this.p.createShader(compositorVertSource,compositorFragSource),this.shaderLoaded=!0}catch(e){console.error("Failed to create compositor shader:",e),this.shaderLoaded=!1}return this.shader}_renderLayer(e){if(!e.visible||e.opacity<=0)return;if(!e.framebuffer)return void console.warn(`Layer ${e.name} has no framebuffer, skipping`);const t=this.p;t.push();const n=getP5BlendMode(e.blendMode,t);t.blendMode(n),this._renderLayerWithShader(e),t.pop()}_renderLayerWithShader(e){const t=this._ensureShader();if(!t)return void console.warn("Compositor shader not available, rendering without shader");const n=this.p;n.shader(t),t.setUniform("layerTexture",e.framebuffer),t.setUniform("maskTexture",e.mask||e.framebuffer),t.setUniform("hasMask",!!e.mask),t.setUniform("layerOpacity",e.opacity),n.imageMode(n.CENTER),n.rectMode(n.CENTER),n.noStroke(),n.fill(255),n.rect(0,0,n.width,n.height),n.resetShader()}render(e,t=null){const n=this.p;n.push(),t?t():n.clear(),n.resetShader(),n.blendMode(n.BLEND);const a=[...e].sort((e,t)=>e.zIndex-t.zIndex);for(const e of a)this._renderLayer(e);n.blendMode(n.BLEND),n.resetShader(),n.pop()}dispose(){this.shader=null,this.shaderLoaded=!1}}class LayerUI{constructor(e,t={}){this.layerSystem=e,this.options={position:t.position||"top-right",width:t.width||280,collapsible:!1!==t.collapsible,draggable:!1!==t.draggable,...t},this.isCollapsed=!1,this.container=null,this.layerElements=new Map,this.selectedLayerId=null,this._createUI(),this._attachStyles()}_createUI(){this.container=document.createElement("div"),this.container.className="p5ml-layer-panel",this.container.style.width=`${this.options.width}px`;const e=document.createElement("div");e.className="p5ml-panel-header",e.innerHTML=`\n      <span class="p5ml-panel-title">Layers</span>\n      <div class="p5ml-header-controls">\n        <button class="p5ml-arrow-btn p5ml-arrow-up" title="Move layer up">↑</button>\n        <button class="p5ml-arrow-btn p5ml-arrow-down" title="Move layer down">↓</button>\n        ${this.options.collapsible?'<button class="p5ml-collapse-btn">−</button>':""}\n      </div>\n    `,this.container.appendChild(e),this.layersContainer=document.createElement("div"),this.layersContainer.className="p5ml-layers-container",this.container.appendChild(this.layersContainer),document.body.appendChild(this.container),this._positionPanel(),this.options.collapsible&&e.querySelector(".p5ml-collapse-btn").addEventListener("click",()=>this.toggle());const t=e.querySelector(".p5ml-arrow-up"),n=e.querySelector(".p5ml-arrow-down");t.addEventListener("click",()=>this._moveSelectedLayer(-1)),n.addEventListener("click",()=>this._moveSelectedLayer(1)),this.options.draggable&&this._makeDraggable(e),document.addEventListener("click",e=>{this.container.contains(e.target)||(this._closeAllDropdowns(),this._deselectLayer())}),document.addEventListener("keydown",e=>{if("ArrowUp"===e.key||"ArrowDown"===e.key){if(e.target.matches("input, select, textarea"))return;e.preventDefault(),"ArrowUp"===e.key?this._moveSelectedLayer(-1):"ArrowDown"===e.key&&this._moveSelectedLayer(1)}})}_closeAllDropdowns(){document.querySelectorAll(".p5ml-layer-dropdown").forEach(e=>{e.style.display="none"})}_positionPanel(){const e={"top-right":{top:"20px",right:"20px"},"top-left":{top:"20px",left:"20px"},"bottom-right":{bottom:"20px",right:"20px"},"bottom-left":{bottom:"20px",left:"20px"}},t=e[this.options.position]||e["top-right"];Object.assign(this.container.style,t)}_makeDraggable(e){let t,n,a,r,i=!1;e.style.cursor="move",e.addEventListener("mousedown",e=>{i=!0,a=e.clientX-(parseInt(this.container.style.left)||0),r=e.clientY-(parseInt(this.container.style.top)||0),this.container.style.right="auto",this.container.style.bottom="auto"}),document.addEventListener("mousemove",e=>{i&&(e.preventDefault(),t=e.clientX-a,n=e.clientY-r,this.container.style.left=t+"px",this.container.style.top=n+"px")}),document.addEventListener("mouseup",()=>{i=!1})}update(){const e=this.layerSystem.getLayers();this.layersContainer.innerHTML="",this.layerElements.clear(),[...e].reverse().forEach(e=>{const t=this._createLayerElement(e);this.layersContainer.appendChild(t),this.layerElements.set(e.id,t)}),this._updateThumbnails()}syncState(){this.layerSystem.getLayers().forEach(e=>{const t=this.layerElements.get(e.id);if(!t)return;const n=t.querySelector(".p5ml-visibility-checkbox");n&&(n.checked=e.visible);const a=t.querySelector(".p5ml-opacity-slider"),r=t.querySelector(".p5ml-opacity-value");if(a&&r){const t=Math.round(100*e.opacity);a.value=t,r.textContent=t+"%"}const i=t.querySelector(".p5ml-blend-select"),s=t.querySelector(".p5ml-blend-indicator");i&&(i.value=e.blendMode),s&&(s.textContent=this._getBlendModeLetter(e.blendMode),s.title=`Blend Mode: ${e.blendMode}`)})}_updateThumbnails(){this.layerSystem.getLayers().forEach(e=>{this._updateLayerThumbnail(e.id)})}_updateLayerThumbnail(e){const t=this.layerSystem.getLayers().find(t=>t.id===e);if(!t)return;const n=this.layerElements.get(e);if(!n)return;const a=n.querySelector(".p5ml-thumbnail-canvas");if(!a)return;const r=a.getContext("2d"),i=t.framebuffer;if(i)try{let e;if(this._drawCheckerboard(r,a.width,a.height),"function"==typeof i.get?e=i.get():i.canvas&&(e=i),e&&e.canvas){const t=e.canvas,n=Math.min(a.width/t.width,a.height/t.height),i=t.width*n,s=t.height*n,o=(a.width-i)/2,l=(a.height-s)/2;r.drawImage(t,o,l,i,s)}}catch(e){console.debug("Could not render thumbnail:",e)}}_createLayerElement(e){const t=document.createElement("div");t.className="p5ml-layer-item",t.dataset.layerId=e.id,t.addEventListener("click",t=>{(t.target.classList.contains("p5ml-layer-row")||t.target.classList.contains("p5ml-layer-name")||t.target.classList.contains("p5ml-layer-thumbnail")||t.target.classList.contains("p5ml-thumbnail-canvas"))&&(this._closeAllDropdowns(),this._selectLayer(e.id),this._updateLayerThumbnail(e.id))});const n=document.createElement("div");n.className="p5ml-layer-row";const a=this._createThumbnail();a.className="p5ml-layer-thumbnail",n.appendChild(a);const r=document.createElement("span");r.className="p5ml-layer-name",r.textContent=e.name,n.appendChild(r);const i=document.createElement("div");i.className="p5ml-right-controls";const s=document.createElement("button");s.className="p5ml-blend-indicator",s.textContent=this._getBlendModeLetter(e.blendMode),s.title=`Blend Mode: ${e.blendMode}`,s.addEventListener("click",e=>{e.stopPropagation();const n=t.querySelector(".p5ml-layer-dropdown"),a="block"===n.style.display;this._closeAllDropdowns(),n.style.display=a?"none":"block"});const o=document.createElement("input");o.type="checkbox",o.className="p5ml-visibility-checkbox",o.checked=e.visible,o.title="Toggle visibility",o.addEventListener("change",t=>{t.stopPropagation(),this.layerSystem.setVisible(e.id,t.target.checked)}),i.appendChild(s),i.appendChild(o),n.appendChild(i);const l=document.createElement("div");l.className="p5ml-layer-dropdown",l.style.display="none";const d=document.createElement("div");d.className="p5ml-control-group";const c=document.createElement("label");c.textContent="OPACITY";const h=document.createElement("span");h.className="p5ml-opacity-value",h.textContent=Math.round(100*e.opacity)+"%";const p=document.createElement("input");p.type="range",p.min="0",p.max="100",p.value=Math.round(100*e.opacity),p.className="p5ml-opacity-slider",p.addEventListener("input",t=>{t.stopPropagation();const n=parseFloat(t.target.value)/100;this.layerSystem.setOpacity(e.id,n),h.textContent=t.target.value+"%"}),d.appendChild(c),d.appendChild(h),d.appendChild(p);const m=document.createElement("div");m.className="p5ml-control-group";const u=document.createElement("label");u.textContent="BLEND MODE";const y=document.createElement("select");return y.className="p5ml-blend-select",Object.values(BlendModes).forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=this._formatBlendModeName(t),n.selected=e.blendMode===t,y.appendChild(n)}),y.addEventListener("change",t=>{t.stopPropagation(),this.layerSystem.setBlendMode(e.id,t.target.value),s.textContent=this._getBlendModeLetter(t.target.value),s.title=`Blend Mode: ${t.target.value}`}),m.appendChild(u),m.appendChild(y),l.appendChild(d),l.appendChild(m),t.appendChild(n),t.appendChild(l),t}_getBlendModeLetter(e){return{[BlendModes.NORMAL]:"N",[BlendModes.MULTIPLY]:"M",[BlendModes.SCREEN]:"S",[BlendModes.OVERLAY]:"O",[BlendModes.DARKEN]:"D",[BlendModes.LIGHTEN]:"Li",[BlendModes.COLOR_DODGE]:"Cd",[BlendModes.COLOR_BURN]:"B",[BlendModes.HARD_LIGHT]:"HL",[BlendModes.SOFT_LIGHT]:"SL",[BlendModes.DIFFERENCE]:"Di",[BlendModes.EXCLUSION]:"E",[BlendModes.ADD]:"A",[BlendModes.SUBTRACT]:"Su"}[e]||"-"}_formatBlendModeName(e){return e.split("_").map(e=>e.charAt(0)+e.slice(1).toLowerCase()).join(" ")}_createThumbnail(){const e=document.createElement("div");e.className="p5ml-thumbnail";const t=document.createElement("canvas");t.className="p5ml-thumbnail-canvas",t.width=60,t.height=60;const n=t.getContext("2d");return this._drawCheckerboard(n,t.width,t.height),e.appendChild(t),e}_drawCheckerboard(e,t,n){e.fillStyle="#333",e.fillRect(0,0,t,n),e.fillStyle="#444";for(let a=0;a<n;a+=4)for(let n=0;n<t;n+=4)(n/4+a/4)%2==0&&e.fillRect(n,a,4,4)}_selectLayer(e){this.selectedLayerId=e,this.layerSystem.getLayers().find(t=>t.id===e),document.querySelectorAll(".p5ml-layer-item").forEach(t=>{t.dataset.layerId==e?(t.classList.add("p5ml-selected"),t.style.background="#3a7bc8",t.style.borderLeft="3px solid #5dade2"):(t.classList.remove("p5ml-selected"),t.style.background="",t.style.borderLeft="")})}_deselectLayer(){this.selectedLayerId=null,document.querySelectorAll(".p5ml-layer-item").forEach(e=>{e.classList.remove("p5ml-selected"),e.style.background="",e.style.borderLeft=""})}_moveSelectedLayer(e){if(null===this.selectedLayerId)return;const t=this.layerSystem.getLayers(),n=t.findIndex(e=>e.id===this.selectedLayerId);if(-1===n)return;const a=n-e;if(a<0||a>=t.length)return;const r=t[n];t[n]=t[a],t[a]=r,"function"==typeof this.layerSystem.reorderLayers&&this.layerSystem.reorderLayers(t),this.update(),this._selectLayer(this.selectedLayerId)}_attachStyles(){if(document.getElementById("p5ml-layer-ui-styles"))return;const e=document.createElement("style");e.id="p5ml-layer-ui-styles",e.textContent="\n      .p5ml-layer-panel {\n        position: fixed;\n        background: rgba(26, 26, 26, 0.95);\n        border: 1px solid #444;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        font-size: 13px;\n        color: #e0e0e0;\n        z-index: 10000;\n        backdrop-filter: blur(10px);\n        overflow: hidden;\n      }\n\n      .p5ml-layer-panel.collapsed .p5ml-layers-container {\n        display: none;\n      }\n\n      .p5ml-panel-header {\n        background: rgba(60, 60, 60, 0.9);\n        padding: 12px 16px;\n        border-bottom: 1px solid #333;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        user-select: none;\n      }\n\n      .p5ml-panel-title {\n        font-weight: 600;\n        font-size: 16px;\n        letter-spacing: 0.5px;\n        color: #ccc;\n      }\n\n      .p5ml-header-controls {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .p5ml-arrow-btn {\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        border-radius: 4px;\n        color: #e8e8e8;\n        font-size: 16px;\n        cursor: pointer;\n        padding: 4px 8px;\n        width: 28px;\n        height: 28px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.15s;\n      }\n\n      .p5ml-arrow-btn:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.3);\n      }\n\n      .p5ml-arrow-btn:active {\n        background: rgba(255, 255, 255, 0.2);\n      }\n\n      .p5ml-collapse-btn {\n        background: none;\n        border: none;\n        color: #aaa;\n        font-size: 18px;\n        cursor: pointer;\n        padding: 0;\n        width: 20px;\n        height: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .p5ml-collapse-btn:hover {\n        color: #fff;\n      }\n\n      .p5ml-layers-container {\n        max-height: 500px;\n        overflow-y: auto;\n        padding: 0;\n        background: #2a2a2a;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.2);\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 4px;\n      }\n\n      .p5ml-layers-container::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      /* Procreate-style layer item */\n      .p5ml-layer-item {\n        background: transparent;\n        border-bottom: 1px solid #3a3a3a;\n        transition: background 0.15s ease;\n        cursor: pointer;\n      }\n\n      .p5ml-layer-item:hover {\n        background: rgba(100, 150, 255, 0.15);\n      }\n\n      /* Selected state */\n      .p5ml-layer-item.p5ml-selected {\n        background: #3a7bc8 !important;\n        border-left: 3px solid #5dade2;\n      }\n\n      .p5ml-layer-item.p5ml-selected:hover {\n        background: #4a8dd8 !important;\n      }\n\n      .p5ml-layer-item.p5ml-selected .p5ml-layer-row {\n        background: transparent;\n      }\n\n      /* Main layer row (horizontal layout) */\n      .p5ml-layer-row {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 10px 12px;\n      }\n\n      /* Thumbnail on the left */\n      .p5ml-layer-thumbnail {\n        flex-shrink: 0;\n      }\n\n      .p5ml-layer-thumbnail canvas {\n        display: block;\n        width: 60px;\n        height: 60px;\n        border: 1px solid #555;\n        border-radius: 4px;\n        image-rendering: pixelated;\n      }\n\n      /* Layer name in center */\n      .p5ml-layer-name {\n        flex: 1;\n        font-weight: 500;\n        font-size: 15px;\n        color: #e8e8e8;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      /* Right side controls */\n      .p5ml-right-controls {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        flex-shrink: 0;\n      }\n\n      /* Blend mode letter indicator */\n      .p5ml-blend-indicator {\n        width: 28px;\n        height: 28px;\n        border-radius: 4px;\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        color: #e8e8e8;\n        font-weight: 600;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.15s;\n        pointer-events: auto;\n      }\n\n      .p5ml-blend-indicator:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.3);\n      }\n\n      /* Visibility checkbox */\n      .p5ml-visibility-checkbox {\n        width: 20px;\n        height: 20px;\n        cursor: pointer;\n        accent-color: #4a90e2;\n        pointer-events: auto;\n      }\n\n      /* Dropdown panel for opacity and blend mode */\n      .p5ml-layer-dropdown {\n        background: rgba(40, 40, 40, 0.95);\n        border-top: 1px solid #555;\n        padding: 16px;\n        display: none;\n      }\n\n      .p5ml-control-group {\n        margin-bottom: 16px;\n      }\n\n      .p5ml-control-group:last-child {\n        margin-bottom: 0;\n      }\n\n      .p5ml-control-group label {\n        font-size: 11px;\n        color: #999;\n        text-transform: uppercase;\n        letter-spacing: 0.8px;\n        font-weight: 600;\n        display: flex;\n        justify-content: space-between;\n        margin-bottom: 8px;\n      }\n\n      .p5ml-opacity-value {\n        color: #e0e0e0;\n        font-weight: 600;\n      }\n\n      .p5ml-opacity-slider {\n        width: 100%;\n        height: 6px;\n        border-radius: 3px;\n        outline: none;\n        -webkit-appearance: none;\n        background: rgba(255, 255, 255, 0.15);\n        margin-top: 4px;\n      }\n\n      .p5ml-opacity-slider::-webkit-slider-thumb {\n        -webkit-appearance: none;\n        appearance: none;\n        width: 18px;\n        height: 18px;\n        border-radius: 50%;\n        background: #fff;\n        cursor: pointer;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .p5ml-opacity-slider::-moz-range-thumb {\n        width: 18px;\n        height: 18px;\n        border-radius: 50%;\n        background: #fff;\n        cursor: pointer;\n        border: none;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .p5ml-blend-select {\n        width: 100%;\n        background: rgba(0, 0, 0, 0.4);\n        border: 1px solid #555;\n        border-radius: 6px;\n        color: #e8e8e8;\n        padding: 10px 12px;\n        font-size: 14px;\n        cursor: pointer;\n        outline: none;\n        margin-top: 4px;\n      }\n\n      .p5ml-blend-select:hover {\n        border-color: #777;\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      .p5ml-blend-select option {\n        background: #2a2a2a;\n        color: #e8e8e8;\n        padding: 8px;\n      }\n\n      /* Hide old thumbnail styles - no longer used */\n      .p5ml-thumbnail-label {\n        display: none;\n      }\n    ",document.head.appendChild(e)}toggle(){this.isCollapsed=!this.isCollapsed,this.container.classList.toggle("collapsed",this.isCollapsed);const e=this.container.querySelector(".p5ml-collapse-btn");e&&(e.innerHTML=this.isCollapsed?"+":"−")}show(){this.container.style.display="block"}hide(){this.container.style.display="none"}dispose(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container)}}class LayerSystem{constructor(e){if(this.p=e,!this.p._renderer||!this.p._renderer.drawingContext)throw new Error("Canvas not initialized. Make sure createCanvas() is called before createLayerSystem()");if(!(this.p._renderer.drawingContext instanceof WebGLRenderingContext||this.p._renderer.drawingContext instanceof WebGL2RenderingContext))throw new Error("LayerSystem requires WebGL mode. Use createCanvas(w, h, WEBGL)");this.layers=new Map,this.layerIdCounter=0,this.activeLayerId=null,this.compositor=new Compositor(e),this.ui=null,this.autoResize=!0,this._lastCanvasWidth=this.p.width,this._lastCanvasHeight=this.p.height}_generateId(){return this.layerIdCounter++}createLayer(e="",t={}){const n=this._generateId(),a=new Layer(this.p,n,e,{...t,zIndex:void 0!==t.zIndex?t.zIndex:n});return this.layers.set(n,a),n}removeLayer(e){const t=this.layers.get(e);t?(this.activeLayerId===e&&this.endLayer(),t.dispose(),this.layers.delete(e)):console.warn(`Layer ${e} not found`)}getLayer(e){return this.layers.get(e)||null}getLayers(){return Array.from(this.layers.values()).sort((e,t)=>e.zIndex-t.zIndex)}getLayerInfo(){return this.getLayers().map(e=>e.toJSON())}beginLayer(e){null!==this.activeLayerId&&(console.warn(`Layer ${this.activeLayerId} is already active. Ending it first.`),this.endLayer());const t=this.layers.get(e);t?(t.begin(),this.activeLayerId=e):console.error(`Layer ${e} not found`)}endLayer(){if(null===this.activeLayerId)return void console.warn("No active layer to end");const e=this.layers.get(this.activeLayerId);e&&e.end(),this.activeLayerId=null}setVisible(e,t){const n=this.layers.get(e);n?n.setVisible(t):console.warn(`Layer ${e} not found`)}setOpacity(e,t){const n=this.layers.get(e);n?n.setOpacity(t):console.warn(`Layer ${e} not found`)}setBlendMode(e,t){const n=this.layers.get(e);n?n.setBlendMode(t):console.warn(`Layer ${e} not found`)}setLayerIndex(e,t){const n=this.layers.get(e);n?n.setZIndex(t):console.warn(`Layer ${e} not found`)}moveLayer(e,t){const n=this.layers.get(e);n?n.setZIndex(n.zIndex+t):console.warn(`Layer ${e} not found`)}reorderLayers(e){e.forEach((e,t)=>{e.setZIndex(t)}),this.ui&&this.ui.update()}setMask(e,t){const n=this.layers.get(e);n?n.setMask(t):console.warn(`Layer ${e} not found`)}clearMask(e){const t=this.layers.get(e);t?t.clearMask():console.warn(`Layer ${e} not found`)}render(e=null){this.autoResize&&this._checkResize();const t=this.getLayers();this.compositor.render(t,e),this.ui&&this.ui.syncState()}_checkResize(){if(this.p.width!==this._lastCanvasWidth||this.p.height!==this._lastCanvasHeight){this._lastCanvasWidth=this.p.width,this._lastCanvasHeight=this.p.height;for(const e of this.layers.values())e.customSize||e.resize(this.p.width,this.p.height)}}setAutoResize(e){this.autoResize=!!e}createUI(e={}){return this.ui&&this.ui.dispose(),this.ui=new LayerUI(this,e),this.ui.update(),this.ui}updateUI(){this.ui&&this.ui.update()}dispose(){null!==this.activeLayerId&&this.endLayer(),this.ui&&(this.ui.dispose(),this.ui=null);for(const e of this.layers.values())e.dispose();this.layers.clear(),this.compositor.dispose()}}function createLayerSystem(e){let t=e;if(!t||t===window)if("undefined"!=typeof window&&window.p5&&window.p5.instance)t=window.p5.instance;else if("undefined"!=typeof window&&window._renderer)t=window;else{if("undefined"==typeof window||"function"!=typeof window.createCanvas)throw new Error("p5.js instance not found. Make sure p5.js is loaded and createCanvas() has been called.");t=window}if(!t)throw new Error("p5.js instance not found. Pass the p5 instance to createLayerSystem()");return new LayerSystem(t)}const VERSION="0.1.0";export{BlendModes,Compositor,DEFAULT_LAYER_OPTIONS,Layer,LayerSystem,LayerUI,VERSION,createLayerSystem,getP5BlendMode};